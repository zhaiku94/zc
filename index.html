<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯æŒç®¡ç†ä¸è´¢åŠ¡åˆ†æç³»ç»Ÿ - å¯¼å…¥ä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #3b82f6; --success: #22c55e; --warn: #f97316; --danger: #ef4444; --bg: #f8fafc; --text: #1e293b; }


/* é’ˆå¯¹ç”»åƒåˆ†æä¸­å›¾è¡¨çš„æ¨ªå‘æ»‘åŠ¨åŒ…è£… */
.scroll-container {
    width: 100%;
    overflow-x: auto; /* å¼€å¯æ¨ªå‘æ»šåŠ¨ */
    display: flex;
    gap: 15px;
    padding-bottom: 10px;
    /* éšè—æ»šåŠ¨æ¡ï¼ˆå¯é€‰ï¼Œå–å†³äºå®¡ç¾ï¼‰ */
    -webkit-overflow-scrolling: touch;
}

/* ç¡®ä¿æ¯ä¸ªå›¾è¡¨åœ¨æ»‘åŠ¨å®¹å™¨ä¸­æœ‰ä¸€ä¸ªå›ºå®šå®½åº¦ï¼Œé˜²æ­¢è¢«æŒ¤å‹ */
.scroll-item {
    flex: 0 0 280px; /* å…³é”®ï¼šæ¯ä¸ªå›¾è¡¨æœ€å°å®½åº¦ 280pxï¼Œä¸æ”¶ç¼© */
    max-width: 80%;
}

/* å…¼å®¹ç§»åŠ¨ç«¯çš„å¹³æ»‘æ»šåŠ¨ */
.scroll-container::-webkit-scrollbar {
    height: 4px;
}
.scroll-container::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
}



        body { font-family: 'PingFang SC', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        .card { background: white; padding: 18px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin-bottom: 15px; border: 1px solid #e2e8f0; }
        .hidden { display: none !important; }
        
        .nav-header { max-width: 1000px; margin: 0 auto 15px; display: flex; justify-content: space-between; align-items: center; }
        button { border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; gap: 4px; }
        .btn-indigo { background: #6366f1; color: white; padding: 8px 16px; font-size: 13px; }
        .btn-outline { background: white; border: 1px solid #cbd5e1; color: #64748b; padding: 7px 14px; font-size: 13px; }
        .btn-mini-export { background: #f8fafc; color: #64748b; padding: 4px 10px; font-size: 12px; border: 1px solid #e2e8f0; justify-content: center; border-radius: 4px; }
        .btn-primary { background: var(--primary); color: white; padding: 10px; justify-content: center; width: 100%; }

        .container { max-width: 1000px; margin: 0 auto; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; box-sizing: border-box; font-size: 14px; background: white; }
        
        .import-area { border: 2px dashed #cbd5e1; padding: 20px; border-radius: 10px; text-align: center; background: #fff; cursor: pointer; margin-bottom: 15px; transition: 0.3s; }
        .import-area:hover, .import-area.dragover { border-color: var(--primary); background: #f0f7ff; }
        #fileInput { display: none; }

/* å®¹å™¨æ”¯æŒæ¨ªå‘æ»šåŠ¨ */
.table-container {
    width: 100%;
    overflow-x: auto; /* å…³é”®ï¼šå¼€å¯æ¨ªå‘æ»šåŠ¨ */
    -webkit-overflow-scrolling: touch; /* æå‡ç§»åŠ¨ç«¯æ»‘åŠ¨æµç•…åº¦ */
    margin-top: 10px;

}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    white-space: nowrap; /* å…³é”®ï¼šå¼ºåˆ¶æ–‡å­—ä¸æ¢è¡Œ */
    min-width: 500px; /* å…³é”®ï¼šä¿è¯åœ¨çª„å±ä¸‹æ’‘å¼€å®¹å™¨äº§ç”Ÿæ»šåŠ¨æ¡ */
}

/* è®©æ“ä½œåˆ—å›ºå®šåœ¨å³ä¾§ï¼ˆå¯é€‰ï¼‰ */
th:last-child, td:last-child {
    position: sticky;
    right: 0;
    background: white; /* å¿…é¡»è®¾ç½®èƒŒæ™¯è‰²é®æŒ¡ä¸‹æ–¹æ–‡å­— */
    z-index: 10;
    box-shadow: -2px 0 5px rgba(0,0,0,0.05); /* åŠ ä¸ªé˜´å½±åŒºåˆ†è¾¹ç•Œ */
}

/* é’ˆå¯¹æ“ä½œæŒ‰é’®çš„å¾®è°ƒ */
.action-link {
    font-weight: bold;
    font-size: 12px;
    text-decoration: none;
    padding: 4px 8px;
}        th { background: #f8fafc; padding: 10px; text-align: left; color: #64748b; border-bottom: 1px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; }

        .stat-item { flex: 1; padding: 10px; border-radius: 8px; background: #f8fafc; border-left: 4px solid var(--primary); }
        .stat-item h4 { margin: 0; font-size: 10px; color: #64748b; }
        .stat-item p { margin: 4px 0 0 0; font-size: 14px; font-weight: bold; }
        
.chart-wrap {
    position: relative;
    height: 300px; /* é»˜è®¤é«˜åº¦ */
    width: 100%;
    max-width: 100%; /* ç¡®ä¿ä¸è¶…å‡ºçˆ¶çº§ */
    margin: 10px auto;
    overflow: hidden; /* é˜²æ­¢æº¢å‡ºå†…å®¹æ˜¾ç¤º */
}

/* é’ˆå¯¹æ‰‹æœºç­‰çª„å±è¿›è¡Œä¼˜åŒ– */
@media (max-width: 600px) {
    .chart-wrap {
        height: 240px; /* å±å¹•çª„æ—¶å‡å°é«˜åº¦ */
    }
}

        .target-input-box { background: #f1f5f9; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #e2e8f0; }
        .highlight-success { color: var(--success); }
        .highlight-danger { color: var(--danger); }

.alert-box { padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 13px; line-height: 1.6;}
.alert-warn { background: #fff7ed; border: 1px solid #ffedd5; color: #9a3412; }
.alert-heart { background: #f0fdf4; border: 1px solid #dcfce7; color: #166534; }
.badge-name { display: inline-block; background: white; padding: 2px 8px; border-radius: 4px; margin: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

#pReminder {
    grid-column: span 2; /* å¼ºåˆ¶æé†’æ¡†æ¨ªè·¨ç½‘æ ¼çš„ä¸¤åˆ—ï¼Œå æ»¡æ•´è¡Œ */
    width: 100%;
}


/* æ—¥æœŸè¾“å…¥æ¡†é¢„è®¾æ–‡å­—æ ·å¼ */
.date-input {
    position: relative;
}

.date-input::before {
    content: attr(data-placeholder);
    position: absolute;
    color: #94a3b8; /* ç°åº¦æ–‡å­—é¢œè‰²ï¼Œä¸ placeholder ä¸€è‡´ */
    background-color: white;
    left: 10px;
    right: 30px; /* ç•™å‡ºæ¸…é™¤æŒ‰é’®å’Œå›¾æ ‡çš„ä½ç½® */
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none; /* ç¡®ä¿ç‚¹å‡»æ–‡å­—ä¹Ÿèƒ½è§¦å‘è¾“å…¥æ¡† */
}

/* å½“è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æˆ–å·²æœ‰å†…å®¹æ—¶ï¼Œéšè—ä¼ªå…ƒç´ æ–‡å­— */
.date-input:focus::before,
.date-input:not(:placeholder-shown)::before,
.date-input:valid::before {
    display: none;
}


/* å¦‚æœéœ€è¦æ›´ç²¾ç»†çš„æ ·å¼ï¼Œå¯ä»¥åœ¨ style æ ‡ç­¾ä¸­å¾®è°ƒ */
.btn-clear-danger {
    background: #fff;
    color: var(--danger);
    border: 1px solid #fee2e2;
    padding: 8px;
    width: 100%;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    transition: 0.2s;
}

.btn-clear-danger:hover {
    background: #fef2f2;
    border-color: var(--danger);
}





.floating-btns {
    position: fixed;
    right: 12px;   /* é è¾¹ä¸€ç‚¹ï¼Œæ›´éšè”½ */
    bottom: 40px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    z-index: 2000;
}

.floating-btns button {
    background: transparent;
    border: none;
    padding: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    outline: none;
    -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»è“æ¡† */
}

.floating-btns svg {
    width: 20px;   /* ç¼©å°å°ºå¯¸ */
    height: 20px;
    opacity: 0.4;  /* åˆå§‹æ›´é€æ˜ï¼Œä¸å¹²æ‰°è¯»æ•° */
    transition: all 0.2s ease;
}

/* äº¤äº’æ•ˆæœ */
.floating-btns button:hover svg {
    opacity: 1;
    transform: scale(1.1);
}

.floating-btns button:active svg {
    transform: scale(0.9);
}

@media (max-width: 600px) {
    .floating-btns {
        right: 10px;
        bottom: 30px;
    }
}


    /* ç¡®ä¿ .hidden ç±»çš„æƒé‡è¶³å¤Ÿ */
.hidden { display: none !important; }

/* è®©åˆ‡æ¢æŒ‰é’®çœ‹èµ·æ¥åƒä¸€ä¸ªè¾…åŠ©åŠŸèƒ½ */
.btn-outline[onclick="toggleImportArea()"]:hover {
    background-color: #f1f5f9;
    border-color: var(--primary);
    color: var(--primary);
}
    </style>

</head>
<body>

<div id="indexPage" class="container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh;">
    <h2 style="margin-bottom: 30px; color: var(--text);">æ¬¢è¿ä½¿ç”¨æ”¯æŒç®¡ç†ç³»ç»Ÿ</h2><br><br>
    <div class="grid-2" style="width: 100%; max-width: 600px; gap: 20px;">



        <div class="card" onclick="showPage('home')" style="cursor: pointer; text-align: center; padding: 40px 20px; transition: 0.3s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='#e2e8f0'">
            <div style="font-size: 40px; margin-bottom: 15px;">ğŸ </div>
            <h3 style="margin: 0; color: var(--primary);">æ”¯æŒè®°å½•ç³»ç»Ÿ</h3>
            <p style="font-size: 12px; color: #64748b; margin-top: 10px;">ç®¡ç†æ—¥å¸¸å¥‰çŒ®è®°å½•ã€è´¢åŠ¡åˆ†æä¸å…³ç³»ç»´æŠ¤</p>
        </div>
        <div class="card" onclick="showPage('supporter')" style="cursor: pointer; text-align: center; padding: 40px 20px; transition: 0.3s;" onmouseover="this.style.borderColor='#6366f1'" onmouseout="this.style.borderColor='#e2e8f0'">
            <div style="font-size: 40px; margin-bottom: 15px;">ğŸ‘¥</div>
            <h3 style="margin: 0; color: #6366f1;">æ”¯æŒè€…ç®¡ç†ç³»ç»Ÿ</h3>
            <p style="font-size: 12px; color: #64748b; margin-top: 10px;">ç®¡ç†æ”¯æŒè€…åå†Œã€æ‰¿è¯ºé¢åº¦ä¸ç”»åƒåˆ†æ</p>
        </div>
    </div>
</div>


<div class="nav-header hidden">
    <h3 id="mainTitle" style="margin:0; flex-grow: 1;">æ”¯æŒç®¡ç†ç³»ç»Ÿ</h3>

    <div id="navButtons" style="display: flex; gap: 8px; align-items: center;">
        <button id="toHome" class="btn-outline hidden" onclick="showPage('home')">ğŸ  æ”¯æŒè®°å½•</button>
        
        <button id="toSupporter" class="btn-outline hidden" onclick="showPage('supporter')">ğŸ‘¥ æ”¯æŒè€…ç®¡ç†</button>
        
        <button id="toIndex" class="btn-outline hidden" onclick="showPage('index')" style="border-color: var(--primary); color: var(--primary);">
            ğŸ  è¿”å›é¦–é¡µ
        </button>
    </div>
</div>

<div id="supporterPage" class="hidden">
    <div class="card">
        <h4>ğŸ“‹ æ–°å¢/ç¼–è¾‘æ”¯æŒè€…æ¡£æ¡ˆ</h4>
        <form id="supporterForm">
            <div class="grid-2">
                <input type="text" id="supStartDate" placeholder="å¼€å§‹æ—¥æœŸ" required onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'">
                <input type="text" id="supEndDate" placeholder="ç»“æŸæ—¥æœŸ" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'">
            </div>
            <div class="grid-2">
                <input type="text" id="supName" list="supNameList" placeholder="å§“å" required onmousedown="forceShowAllSupporterNames(this)">
                <datalist id="supNameList"></datalist>
                <input type="text" id="supGender" list="genderList" placeholder="æ€§åˆ«" onmousedown="forceShowAll(this)" required>
                <datalist id="genderList"><option value="ç”·"><option value="å¥³"><option value="å…¶ä»–"></option></datalist>
            </div>
            <div class="grid-2">
                <input type="text" id="supCity" list="supCityList" placeholder="åŸå¸‚" onmousedown="forceShowAllCities(this)">
                <datalist id="supCityList"></datalist>
                <input type="text" id="supFreq" list="supFreqList" placeholder="é¢‘ç‡" onmousedown="forceShowAll(this)" required>
                <datalist id="supFreqList"><option value="æŒ‰æœˆ"><option value="æŒ‰å¹´"><option value="ä¸å®šæœŸ"></datalist>
            </div>
            <div class="grid-2" style="margin-top:10px;">
                <input type="number" id="supAmount" placeholder="æ‰¿è¯ºé‡‘é¢" step="0.01">
                <input type="text" id="supRemark" placeholder="å¤‡æ³¨">
            </div>
            <button type="submit" class="btn-primary" style="margin-top:10px;">ä¿å­˜æ”¯æŒè€…æ¡£æ¡ˆ</button>
        </form>

        <div style="margin-top: 10px;">
            <button type="button" class="btn-outline" style="width: 100%; justify-content: center; border-style: dashed; color: #64748b;" onclick="toggleSupImportArea()">
                ğŸ‘¤ å±•å¼€/éšè—æ‰¹é‡å¯¼å…¥åå†Œ (CSV)
            </button>
        </div>

        <div id="supImportWrapper" class="hidden" style="margin-top: 15px;">
            <div id="supDropZone" class="import-area" onclick="document.getElementById('supFileInput').click()" ondragover="handleDrag(event, true, 'supDropZone')" ondragleave="handleDrag(event, false, 'supDropZone')" ondrop="handleSupDrop(event)">
                <p style="margin:0; font-size:14px; color:#475569; font-weight: bold;">ğŸ‘¤ ç‚¹å‡»å¯¼å…¥æ”¯æŒè€…åå†Œ (CSV)</p>
                <input type="file" id="supFileInput" accept=".csv" style="display:none;" onchange="processSupFile(this.files[0])">
            </div>
            <div style="text-align: right; margin-top: -5px;">
                <a href="javascript:void(0)" onclick="downloadSupTemplate()" style="font-size: 11px; color: var(--primary);">ä¸‹è½½æ”¯æŒè€…æ¨¡ç‰ˆ</a>
            </div>
        </div>
    </div> <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
            <h4 style="margin:0">æ”¯æŒè€…åå†Œ <span id="supRecordCount" style="font-size:12px; color:#64748b; font-weight:normal;"></span></h4>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>å¼€å§‹æ—¥æœŸ</th><th>å§“å</th><th>æ€§åˆ«</th><th>åŸå¸‚</th><th>é¢‘ç‡</th><th>é‡‘é¢</th><th>çŠ¶æ€</th><th style="text-align:center">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="supporterBody"></tbody>
            </table>
        </div>
    </div>

    <div style="display: flex; gap: 8px; margin-top: 12px;">
        <button type="button" class="btn-outline" style="flex: 1; justify-content: center; padding: 8px;" id="btnSupShowAll" onclick="toggleSupShowAll()">æ˜¾ç¤ºå…¨éƒ¨è®°å½•</button>
        <button type="button" class="btn-outline" style="flex: 1; justify-content: center; padding: 8px;" onclick="exportSupportersToCSV()">ğŸ“¤ å¯¼å‡º CSV</button>
        <button type="button" class="btn-outline" style="color: var(--danger); border-color: #fecaca; flex: 1; justify-content: center; padding: 8px;" onclick="clearAllSupporters()">ğŸ—‘ï¸ æ¸…ç©ºæ¡£æ¡ˆ</button>
    </div>

    <br>

    <button id="tosupAnalysis" class="btn-primary" style="background-color: #6366f1;" onclick="showPage('supporterAnalysisPage')">ğŸ“Š æ”¯æŒè€…åˆ†æ</button>

</div> 



<div id="supporterAnalysisPage" class="hidden">

  <div class="card">
    
    <div class="grid-2">
    <div class="stat-item" style="border-left-color: #6366f1;">
        <h4>æ”¯æŒè€…æ€»äººæ•°</h4>
        <p id="anaTotalCount">0 ä½ (æ”¯æŒä¸­)</p>
    </div>
    <div class="stat-item" style="border-left-color: #22c55e;">
        <h4>æ‰¿è¯ºæœˆæ€»é¢ (æ´»è·ƒ)</h4>
        <p id="anaTotalPromise">Â¥ 0.00</p>
    </div>
</div>

<div class="grid-2" style="margin-top: 10px; align-items: center;">
    <div class="stat-item" style="border-left-color: #f59e0b; background: #fffbeb;">
        <h4>è®¾å®šæœˆç­¹æ¬¾ç›®æ ‡</h4>
        <input type="number" id="manualMonthlyTarget" placeholder="ç‚¹å‡»è¾“å…¥ç›®æ ‡é‡‘é¢" 
               oninput="calculateGoalProgress()" 
               style="border:none; background:transparent; padding:0; font-size:14px; font-weight:bold; color:var(--text); width:100%; outline:none;">
    </div>
    <div class="stat-item" id="goalGapItem" style="border-left-color: #cbd5e1;">
        <h4>æœˆç­¹æ¬¾å·®é¢</h4>
        <p id="anaGoalGap">Â¥ 0.00</p>
    </div>
</div>

<div style="margin-top: 15px; padding: 0 5px;">
    <div style="display:flex; justify-content:space-between; font-size:11px; color:#64748b; margin-bottom:5px;">
        <span>ç­¹æ¬¾è¾¾æˆè¿›åº¦</span>
        <span id="anaProgressPercent">0%</span>
    </div>
    <div style="width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
        <div id="anaProgressBar" style="width: 0%; height: 100%; background: var(--success); transition: 0.5s;"></div>
    </div>
</div>
</div>


<div class="card" style="padding: 10px; text-align: center; margin-bottom: 15px;">
    <div style="display: inline-flex; background: #f1f5f9; padding: 4px; border-radius: 8px;">
        <button id="btnViewCount" class="btn-indigo" style="padding: 6px 16px; font-size: 12px;" onclick="switchSupAnalysisView('count')">æŒ‰äººæ•°</button>
        <button id="btnViewAmount" class="btn-outline" style="padding: 6px 16px; font-size: 12px; border:none;" onclick="switchSupAnalysisView('amount')">æŒ‰é‡‘é¢</button>
    </div>
</div>


<div class="card">
   <div class="scroll-container" style="
    display: flex; 
    flex-wrap: wrap; /* å…³é”®ï¼šå±å¹•å¤Ÿå®½æ—¶å¹¶æ’ï¼Œä¸å¤Ÿå®½æ—¶è‡ªåŠ¨æ¢è¡Œæˆ–ç¼©æ”¾ */
    gap: 15px; 
    margin-top: 20px; 
    width: 100%;
    box-sizing: border-box;
">
    <div class="scroll-item" style="
        flex: 1 1 240px; /* æœ€å°å®½åº¦240pxï¼Œå‰©ä½™ç©ºé—´å¹³åˆ† */
        max-width: 100%; 
        min-width: 0; /* å…è®¸ flex é¡¹ç›®ç¼©å°åˆ°æ¯”å†…å®¹æ›´å°ï¼Œé˜²æ­¢æº¢å‡º */
    ">
        <h5 style="text-align:center; font-size:12px; color:#64748b; margin-bottom:8px;">æ€§åˆ«åˆ†å¸ƒ</h5>
        <div style="position: relative; height: 180px; width: 100%;">
            <canvas id="chartGender"></canvas>
        </div>
    </div>
    
    <div class="scroll-item" style="
        flex: 1 1 240px; 
        max-width: 100%; 
        min-width: 0;
    ">
        <h5 style="text-align:center; font-size:12px; color:#64748b; margin-bottom:8px;">æ”¯æŒé¢‘ç‡</h5>
        <div style="position: relative; height: 180px; width: 100%;">
            <canvas id="chartFreq"></canvas>
        </div>
    </div>
</div>
    
    <div style="margin-top:20px;">
        <h5 style="text-align:center; font-size:12px; color:#64748b;">åŸå¸‚åˆ†å¸ƒ (Top 5)</h5>
        <div style="height:220px;"><canvas id="chartCity"></canvas></div>
    </div>
</div>
    </div>
</div>


<div class="container">
    <div id="homePage" class="hidden">
        
        <br>

        <div class="card">
            <h4>ğŸ“‹ æ–°å¢/ç¼–è¾‘æ”¯æŒè®°å½•</h4>
            <form id="recordForm">
                <div class="grid-2">
                    <input type="text" id="date" placeholder="æ—¥æœŸ" required onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'">
<input type="text" id="name" list="nameList" placeholder="å§“åï¼ˆä¸é«˜æ˜ä¸€è‡´ï¼‰" required 
       onmousedown="forceShowAll(this)" 
       oninput="autoFillSupporterInfo()">                    <datalist id="nameList"></datalist>
                </div>

                <div class="grid-2">
   <input type="text" id="method" list="methodList" placeholder="æ–¹å¼" onmousedown="forceShowAll(this)">
    <datalist id="methodList">
        <option value="é“¶è¡Œè½¬è´¦">
        <option value="å¾®ä¿¡">
        <option value="æ”¯ä»˜å®">
        <option value="ç°é‡‘">
    </datalist>
    
    <input type="text" id="gender" list="homeGenderList" placeholder="æ€§åˆ«" onmousedown="forceShowAll(this)">
    <datalist id="homeGenderList">
        <option value="ç”·">
        <option value="å¥³">
        <option value="å…¶ä»–">

    </datalist>
</div>

                <div class="grid-2">
                    <input type="text" id="frequency" list="freqList" placeholder="é¢‘ç‡" onmousedown="forceShowAll(this)" ondblclick="this.value='';" required>
                    <datalist id="freqList">
                        <option value="æŒ‰æœˆ"><option value="æŒ‰å¹´"><option value="ä¸å®šæœŸ">
                    </datalist>

                    <input type="text" id="remark" list="remarkList" placeholder="å¤‡æ³¨" onmousedown="forceShowAll(this)">
                    <datalist id="remarkList">
                        <option value="æ—¥å¸¸"><option value="çŸ­å®£"><option value="å…¶ä»–">
                    </datalist>
                </div>

                <div class="grid-2">
                    <input type="text" id="area" list="areaList" placeholder="åœ°åŒº" required onmousedown="forceShowAll(this)">
                    <datalist id="areaList"></datalist>
                    <input type="number" id="amount" step="0.01" placeholder="é‡‘é¢" required>
                </div>

                <button type="submit" class="btn-primary">ä¿å­˜è®°å½•</button>
            </form>

            <div style="margin-top: 10px;">
                <button type="button" class="btn-outline" style="width: 100%; justify-content: center; border-style: dashed; color: #64748b;" onclick="toggleImportArea()">
                    ğŸ“¥ å±•å¼€/éšè—æ‰¹é‡å¯¼å…¥è®°å½• (CSV)
                </button>
            </div>

            <div id="batchImportWrapper" class="hidden" style="margin-top: 15px;">
                <div id="dropZone" class="import-area">
                    <p style="margin:0; font-size:14px; color:#475569; font-weight: bold;">ğŸ“„ ç‚¹å‡»é€‰æ‹© æˆ– æ‹–æ‹½ CSV æ–‡ä»¶è¿›è¡Œå¯¼å…¥</p>
                    <p style="margin:5px 0 0 0; font-size:11px; color:#94a3b8;">æ”¯æŒæ ¼å¼ï¼šæ—¥æœŸ, å§“å, åœ°åŒº, é‡‘é¢, é¢‘ç‡, å¤‡æ³¨</p>
                    <input type="file" id="fileInput" accept=".csv" style="display:none;">
                </div>
                <div style="text-align: right; margin-top: 5px;">
                    <a href="javascript:void(0)" onclick="downloadTemplate(event)" style="font-size: 11px; color: var(--primary); text-decoration: underline;">
                        ä¸‹è½½ CSV å¯¼å…¥æ¨¡ç‰ˆ
                    </a>
                </div>
            </div>
        </div> <br>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                <h4 style="margin:0">è®°å½•ç®¡ç† <span id="recordCount" style="font-size:12px; color:#64748b; font-weight:normal;"></span></h4>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
    <tr>
        <th>æ—¥æœŸ</th>
        <th>å§“å</th>
        <th>æ€§åˆ«</th> <th>æ–¹å¼</th> <th>åœ°åŒº</th>
        <th>é‡‘é¢</th>
        <th>é¢‘ç‡</th> <th>å¤‡æ³¨</th> <th style="text-align:center">æ“ä½œ</th>
    </tr>
</thead>
                    <tbody id="recordBody"></tbody>
                </table>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px;">
                <button class="btn-mini-export" onclick="toggleShowAll()" id="btnShowAll">æ˜¾ç¤ºå…¨éƒ¨</button>
                <button class="btn-mini-export" onclick="exportToCSV()">ğŸ“¤ å¯¼å‡º CSV</button>
                <button class="btn-mini-export" onclick="exportToGaomingCSV()" style="background: #f0fdf4; color: #166534;">âœ¨ å¯¼å‡ºé«˜æ˜</button>
                <button class="btn-mini-export" onclick="clearAllData()" style="color:var(--danger);">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
            </div>
        </div> <button id="toAnalysis" class="btn-primary" style="background-color: #6366f1; margin-top: 10px;" onclick="showPage('analysis')">ğŸ“Š è´¢åŠ¡åˆ†æä¸­å¿ƒ</button>

    </div> </div>






    <div id="analysisPage" class="hidden">
        <div class="card">
            <h4>ğŸ“ˆ å…¨å±€æ¦‚è§ˆ</h4>
            <div class="grid-2">
                <div class="stat-item"><h4>ä»Šå¹´ç´¯è®¡</h4><p id="totalYear">Â¥ 0.00</p></div>
                <div class="stat-item"><h4>æœ€åæ”¯æŒ</h4><p id="lastDetail">-</p></div>
            </div>
            <div class="chart-wrap"><canvas id="mainDoughnut"></canvas></div>
        </div>


 <div class="card">
            <h4>ğŸ¯ ç­¹æ¬¾ç›®æ ‡åˆ†æ</h4>
            <div class="grid-4">
                <div class="stat-item" style="border-left-color:var(--primary)"><h4>12æœˆå¹³å‡å¥‰çŒ®</h4><p id="avgMonthlyAmt">Â¥ 0.00</p></div>
                <div class="stat-item" style="border-left-color:var(--warn)"><h4>å¹³å‡è¾¾æˆç‡</h4><p id="avgAchievement">0%</p></div>
                <div class="stat-item" style="border-left-color:var(--danger)"><h4>å¹³å‡æ¯æœˆç¼ºå£</h4><p id="avgGap">Â¥ 0.00</p></div>
                <div class="stat-item" style="border-left-color:#6366f1"><h4>å¹´åº¦å®Œæˆç‡</h4><p id="annualProgressText">0%</p></div>
            </div>
            <div class="chart-wrap"><canvas id="monthlyGoalChart"></canvas></div>
            <div class="target-input-box">
                <label style="font-size:11px; font-weight:bold;">æœˆç­¹æ¬¾ç›®æ ‡: </label>
                <input type="number" id="monthlyTargetInput" placeholder="è¾“å…¥æ¯æœˆç›®æ ‡" oninput="updateGoals()" style="width:120px; display:inline-block; margin:0 10px;">
                <span style="font-size:12px;">å¹´åº¦æ€»ç›®æ ‡: <b id="annualTargetDisplay">Â¥ 0.00</b></span>
            </div>
        </div>

        <div class="card">
            <h4>ğŸ“Š ç»´åº¦ç»Ÿè®¡å¯¹æ¯”</h4>
            <div class="grid-2">
                <select id="vDimension" onchange="updateDimensionChart()">
                    <option value="person">æŒ‰æ”¯æŒè€…æ’å</option>
                    <option value="city">æŒ‰åŸå¸‚åˆ†å¸ƒ</option>
                    <option value="time">æ—¶é—´è¶‹åŠ¿å›¾</option>
                </select>
                <select id="vRange" onchange="updateDimensionChart()">
                    <option value="12m">è¿‡å» 12 ä¸ªæœˆ</option>
                    <option value="year">ä»Šå¹´</option>
                </select>
            </div>
            <div class="chart-wrap"><canvas id="vBarChart"></canvas></div>
        </div>

<div class="card">
    <h4>ğŸ¤ å…³ç³»ç»´æŠ¤çœ‹æ¿</h4>
    <div id="maintenancePanel">
        <div class="alert-box alert-warn">
            <strong>âš ï¸ éœ€å…³æ³¨ï¼ˆé€¾ 2 ä¸ªæœˆæœªæ”¯æŒï¼‰ï¼š</strong>
            <div id="dormantList" style="margin-top:5px;">è®¡ç®—ä¸­...</div>
        </div>
        <div class="alert-box alert-heart" style="margin-top:10px;">
            <strong>â¤ï¸ ç‰¹åˆ«è‡´è°¢ï¼ˆè¿‘ 6 ä¸ªæœˆæŒç»­æ”¯æŒï¼‰ï¼š</strong>
            <div id="loyalList" style="margin-top:5px;">è®¡ç®—ä¸­...</div>
        </div>
    </div>
</div>

        
        <div class="card">
            <h4>ğŸ‘¤ æ”¯æŒè€…ç”»åƒ</h4>
            <div class="grid-2">
                <input type="text" id="pSearch" list="pSearchList" placeholder="æœç´¢å§“å..." oninput="analyzePerson()" 
	onmousedown="forceShowAll(this)">
                <datalist id="pSearchList"></datalist>
               <select id="pRange" onchange="analyzePerson()">
    <option value="12m">è¿‡å» 12 ä¸ªæœˆè¶‹åŠ¿</option>
    <option value="monthly">å»å¹´æ¯æœˆæ˜ç»†</option>
    <option value="yearly">æŸ¥çœ‹æ¯å¹´æ€»é¢</option>
</select>
<div id="pReminder" style="width:100%; margin-top:10px;"></div>
            </div>

<div id="pStats" style="display:none; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 10px;">
    <div class="stat-item" style="border-left-color:var(--success)"><h4>ç´¯è®¡æ€»é¢</h4><p id="pTotalAmount">Â¥ 0.00</p></div>
    <div class="stat-item" style="border-left-color:#6366f1"><h4>æœ€è¿‘1ç¬”</h4><p id="pLastRecord">-</p></div>
    <div class="stat-item" style="border-left-color:var(--warn)"><h4>è®¾å®šæœˆæ‰¿è¯ºé¢</h4><p id="pMonthlyPromise">Â¥ 0.00</p></div>
    <div class="stat-item" style="border-left-color:#f59e0b"><h4>æœ¬å¹´åº¦æœˆå¹³å‡</h4><p id="pAvgYearly">Â¥ 0.00</p></div>
</div>


            <div class="chart-wrap"><canvas id="pBarChart"></canvas></div>
        </div>

       <div class="card">
    <h4>ğŸ’³ æ”¯ä»˜æ–¹å¼æ—¶é—´æ®µç»Ÿè®¡</h4>
    <div class="grid-2">
        <input type="date" id="mStart" onchange="calculateMethodStats()">
        <input type="date" id="mEnd" onchange="calculateMethodStats()">
    </div>
    
    <div id="methodStatsResult" style="margin-top: 15px;">
        <p style="text-align: center; color: #94a3b8; font-size: 13px;">è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´ä»¥æŸ¥çœ‹ç»Ÿè®¡</p>
    </div>

    <div class="chart-wrap" style="height: 150px; margin-top: 10px;">
        <canvas id="methodDonutChart"></canvas>
    </div>
</div>
    </div>
</div>

<script>


window.addEventListener('storage', (e) => {
    if (e.key === 'sup_members_v1') {
        // ä»å­˜å‚¨åŠ è½½æœ€æ–°æ•°æ®
        supporters = JSON.parse(e.newValue) || [];
        // å®æ—¶åˆ·æ–°æ‰€æœ‰ç»„ä»¶
        renderSupporters();
        renderSupporterAnalysis();
    }
});

// å®šä¹‰ä¸€ç»„ç¾è§‚ä¸”å¯¹æ¯”é²œæ˜çš„é¢œè‰²
const METHOD_COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#6366f1', '#8b5cf6', '#ec4899', '#94a3b8'];

// å…¨å±€å˜é‡ç”¨äºå­˜å‚¨åˆ†æå›¾è¡¨å®ä¾‹ï¼Œé˜²æ­¢é‡å¤æ¸²æŸ“å†²çª
let supCharts = {};


let currentSupViewMode = 'count'; // 'count' æˆ– 'amount'

function autoFillSupporterInfo() {
    const nameInput = document.getElementById('name').value.trim();
    if (!nameInput) return;

    // ä» records æ•°ç»„ä¸­å¯»æ‰¾è¯¥æ”¯æŒè€…çš„æœ€è¿‘ä¸€æ¡å†å²è®°å½•
    // å› ä¸º records æ˜¯æŒ‰æ—¶é—´å€’åºæ’åˆ—çš„ï¼Œfind æ‰¾åˆ°çš„ç¬¬ä¸€æ¡å°±æ˜¯æœ€è¿‘çš„
    const lastRecord = records.find(r => r.name === nameInput);

    if (lastRecord) {
        // è‡ªåŠ¨å¡«å†™å„ä¸ªå­—æ®µ
        if (lastRecord.gender) document.getElementById('gender').value = lastRecord.gender;
        if (lastRecord.method) document.getElementById('method').value = lastRecord.method;
        if (lastRecord.frequency) document.getElementById('frequency').value = lastRecord.frequency;
        if (lastRecord.area) document.getElementById('area').value = lastRecord.area;
        
        // è§†è§‰æç¤ºï¼ˆå¯é€‰ï¼‰ï¼šå°†è¾¹æ¡†çŸ­æš‚å˜ç»¿ï¼Œæç¤ºç”¨æˆ·å·²è‡ªåŠ¨åŒ¹é…
        const fields = ['gender', 'method', 'frequency', 'area'];
        fields.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.style.transition = '0.3s';
                el.style.backgroundColor = '#f0fdf4'; // æ·¡æ·¡çš„ç»¿è‰²èƒŒæ™¯
                setTimeout(() => el.style.backgroundColor = 'white', 500);
            }
        });
    }
}

function calculateMethodStats() {
    const start = document.getElementById('mStart').value;
    const end = document.getElementById('mEnd').value;
    const resultDiv = document.getElementById('methodStatsResult');
    
    if (!start || !end) return;

    const startTime = new Date(start.replace(/-/g, '/')).getTime();
    const endTime = new Date(end.replace(/-/g, '/')).getTime() + 86400000;

    const filtered = records.filter(r => r.ts >= startTime && r.ts < endTime);

    if (filtered.length === 0) {
        resultDiv.innerHTML = `<p style="text-align:center; color:var(--danger); padding:20px;">è¯¥æ—¶æ®µå†…æ— è®°å½•</p>`;
        if(charts.method) charts.method.destroy();
        return;
    }

    // æŒ‰æ–¹å¼èšåˆ
    const stats = filtered.reduce((obj, r) => {
        const m = r.method || "æœªå¡«å†™";
        obj[m] = (obj[m] || 0) + r.amount;
        return obj;
    }, {});

    const sortedStats = Object.entries(stats).sort((a, b) => b[1] - a[1]);
    const totalRangeAmount = filtered.reduce((s, r) => s + r.amount, 0);

    // ç”Ÿæˆè¿›åº¦æ¡ HTML
    let html = `<div style="background:#f8fafc; padding:12px; border-radius:8px;">
                    <div style="font-size:12px; color:#64748b; margin-bottom:12px;">
                        æ—¶æ®µæ€»è®¡ï¼š<b style="color:var(--text); font-size:14px;">Â¥ ${totalRangeAmount.toFixed(2)}</b>
                    </div>`;
    
   sortedStats.forEach(([method, amt], i) => {
        const percent = ((amt / totalRangeAmount) * 100).toFixed(1);
        const currentColor = METHOD_COLORS[i % METHOD_COLORS.length];
        
        html += `
            <div style="margin-bottom: 12px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; font-size:13px;">
                    <span>${method}</span>
                    <span><b>Â¥ ${amt.toFixed(2)}</b> <small style="color:#94a3b8; margin-left:4px;">${percent}%</small></span>
                </div>
                <div style="width:100%; height:6px; background:#e2e8f0; border-radius:3px; overflow:hidden;">
                    <div style="width:${percent}%; height:100%; background:${currentColor}; border-radius:3px; transition: width 0.6s ease;"></div>
                </div>
            </div>`;
    });
    html += `</div>`;
    resultDiv.innerHTML = html;

    // åŒæ­¥æ¸²æŸ“åœ†ç¯å›¾
    function renderMethodChart(sortedData) {
    const ctx = document.getElementById('methodDonutChart').getContext('2d');
    if (charts.method) charts.method.destroy();
    
    const labels = sortedData.map(item => item[0]);
    const values = sortedData.map(item => item[1]);
    
    charts.method = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                // ç›´æ¥åˆ‡å–ä¸æ•°æ®é•¿åº¦ä¸€è‡´çš„é¢œè‰²å­é›†
                backgroundColor: METHOD_COLORS.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'right', 
                    labels: { boxWidth: 10, font: { size: 10 }, padding: 15 } 
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const val = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percent = ((val / total) * 100).toFixed(1) + '%';
                            return ` Â¥${val.toFixed(2)} (${percent})`;
                        }
                    }
                }
            },
            cutout: '65%'
        }
    });
}
    renderMethodChart(sortedStats);
}

// æ§åˆ¶é¦–é¡µæ‰¹é‡å¯¼å…¥åŒºåŸŸçš„æ˜¾ç¤ºä¸éšè—
function toggleImportArea() {
    const wrapper = document.getElementById('batchImportWrapper');
    wrapper.classList.toggle('hidden');
}
// åˆ‡æ¢æ”¯æŒè€…åå†Œå¯¼å…¥åŒºåŸŸ
function toggleSupImportArea() {
    const wrapper = document.getElementById('supImportWrapper');
    wrapper.classList.toggle('hidden');
}
// å»ºè®®ï¼šåœ¨ processFile å‡½æ•°æˆåŠŸå¯¼å…¥åï¼Œè‡ªåŠ¨éšè—è¯¥åŒºåŸŸ
// æ‰¾åˆ°åŸæœ¬çš„ processFile å‡½æ•°ï¼Œåœ¨ alert(`å¯¼å…¥æˆåŠŸ...`) åé¢åŠ ä¸Šï¼š
// document.getElementById('batchImportWrapper').classList.add('hidden');

function switchSupAnalysisView(mode) {
    currentSupViewMode = mode;
    // åˆ‡æ¢æŒ‰é’®æ ·å¼
    const btnCount = document.getElementById('btnViewCount');
    const btnAmt = document.getElementById('btnViewAmount');
    
    if (mode === 'count') {
        btnCount.className = 'btn-indigo';
        btnAmt.className = 'btn-outline';
        btnAmt.style.border = 'none';
    } else {
        btnCount.className = 'btn-outline';
        btnCount.style.border = 'none';
        btnAmt.className = 'btn-indigo';
    }
    
    // é‡æ–°æ¸²æŸ“
    renderSupporterAnalysis();
}




/**
 * è®¡ç®—å¹¶æ›´æ–°æœˆç­¹æ¬¾è¿›åº¦ä¸å·®é¢
 */
function calculateGoalProgress() {
    // 1. è·å–æ‰¿è¯ºæ€»é¢ï¼ˆä»é¡µé¢å·²æœ‰å…ƒç´ ä¸­æå–æ•°å­—ï¼‰
    const promiseText = document.getElementById('anaTotalPromise').innerText;
    const totalActiveAmount = parseFloat(promiseText.replace(/[^\d.-]/g, '')) || 0;

    // 2. è·å–æ‰‹åŠ¨è¾“å…¥çš„ç›®æ ‡
    const targetInput = document.getElementById('manualMonthlyTarget');
    const targetAmount = parseFloat(targetInput.value) || 0;

    // ä¿å­˜ç›®æ ‡åˆ°æœ¬åœ°å­˜å‚¨ï¼Œé˜²æ­¢åˆ·æ–°é¡µé¢åä¸¢å¤±
    localStorage.setItem('sup_manual_goal', targetAmount);

    const gapEl = document.getElementById('anaGoalGap');
    const gapItem = document.getElementById('goalGapItem');
    const barEl = document.getElementById('anaProgressBar');
    const percentEl = document.getElementById('anaProgressPercent');

    if (targetAmount <= 0) {
        gapEl.innerText = "æœªè®¾å®šç›®æ ‡";
        gapItem.style.borderLeftColor = "#cbd5e1";
        barEl.style.width = "0%";
        percentEl.innerText = "0%";
        return;
    }

    // 3. è®¡ç®—å·®é¢ (ç›®æ ‡ - å®é™…)
    const gap = targetAmount - totalActiveAmount;
    if (gap <= 0) {
        gapEl.innerText = "å·²è¾¾æ ‡ (ç›ˆä½™ Â¥" + Math.abs(gap).toLocaleString() + ")";
        gapItem.style.borderLeftColor = "var(--success)";
        gapEl.style.color = "var(--success)";
    } else {
        gapEl.innerText = "ç¼ºå£ Â¥" + gap.toLocaleString();
        gapItem.style.borderLeftColor = "var(--danger)";
        gapEl.style.color = "var(--danger)";
    }

    // 4. è®¡ç®—ç™¾åˆ†æ¯”å¹¶æ›´æ–°è¿›åº¦æ¡
    let percent = Math.round((totalActiveAmount / targetAmount) * 100);
    percentEl.innerText = percent + "%";
    // è¿›åº¦æ¡æœ€é•¿ 100%
    barEl.style.width = Math.min(percent, 100) + "%";
    // å¦‚æœè¶…é¢ï¼Œå˜è‰²æç¤º
    barEl.style.background = percent >= 100 ? "#059669" : "var(--success)";
}

/**
 * å®Œæ•´ç‰ˆï¼šæ”¯æŒè€…ç¾¤ä½“ç”»åƒåˆ†æå‡½æ•°
 * é€»è¾‘ï¼šä»…ç»Ÿè®¡â€œæ”¯æŒä¸­â€çš„æ¡£æ¡ˆï¼Œé‡‘é¢ä¸å«å·²ç»“æŸæ•°æ®
 */
function renderSupporterAnalysis() {
    
    // --- æ–°å¢ï¼šä»æœ¬åœ°å­˜å‚¨è¯»å–å¹¶å›å¡«ç›®æ ‡å€¼ ---
    const savedGoal = localStorage.getItem('sup_manual_goal');
    const targetInput = document.getElementById('manualMonthlyTarget');
    
    // åªæœ‰å½“è¾“å…¥æ¡†å½“å‰ä¸ºç©ºï¼Œä¸”æœ¬åœ°æœ‰ä¿å­˜è®°å½•æ—¶æ‰å›å¡«
    if (savedGoal && (!targetInput.value || targetInput.value == "0")) {
        targetInput.value = savedGoal;
    }

    const countEl = document.getElementById('anaTotalCount');
    const promiseEl = document.getElementById('anaTotalPromise');

    // 1. è·å–å½“å‰æ—¥æœŸç”¨äºåˆ¤æ–­æ˜¯å¦è¿‡æœŸ
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // 2. æ ¸å¿ƒè¿‡æ»¤ï¼šç­›é€‰å‡ºæ­£åœ¨æ”¯æŒä¸­çš„æˆå‘˜
    // è§„åˆ™ï¼šç»“æŸæ—¥æœŸä¸ºç©ºï¼Œæˆ–è€…ç»“æŸæ—¥æœŸæ™šäº/ç­‰äºä»Šå¤©
    const activeSupporters = supporters.filter(s => {
        if (!s.endDate || s.endDate.trim() === "") return true; 
        const end = new Date(s.endDate.replace(/-/g, '/'));
        return end >= today;
    });

    // 3. å¤„ç†æ— æ•°æ®æƒ…å†µ
    if (!activeSupporters || activeSupporters.length === 0) {
        if(countEl) countEl.innerText = "0 ä½";
        if(promiseEl) promiseEl.innerText = "Â¥ 0.00";
        // é”€æ¯æ—§å›¾è¡¨
        Object.keys(supCharts).forEach(key => {
            if (supCharts[key]) { supCharts[key].destroy(); supCharts[key] = null; }
        });
        return;
    }

    // 4. æ›´æ–°åŸºç¡€ç»Ÿè®¡çœ‹æ¿
    // æ˜¾ç¤ºæ´»è·ƒäººæ•°
    document.getElementById('anaTotalCount').innerText = `${activeSupporters.length} ä½ (æ”¯æŒä¸­)`;
    
// --- ä¿®æ”¹åçš„æ‰¿è¯ºæœˆæ€»é¢è®¡ç®—é€»è¾‘ ---

// è®¡ç®—æ´»è·ƒæ‰¿è¯ºæœˆæ€»é¢
const totalAmt = activeSupporters.reduce((sum, s) => {
    let amount = parseFloat(s.amount) || 0;
    let monthlyContribution = 0;

    // æ ¹æ®é¢‘ç‡è¿›è¡Œæœˆåº¦æŠ˜ç®—
    if (s.freq === 'æŒ‰æœˆ') {
        monthlyContribution = amount;
    } else if (s.freq === 'æŒ‰å¹´') {
        monthlyContribution = amount / 12; // å¹´è´¹åˆ†æ‘Šåˆ°æ¯æœˆ
    } else {
        // â€œä¸å®šæœŸâ€æˆ–å…¶ä»–æƒ…å†µï¼Œé€šå¸¸ä¸è®¡å…¥ç¨³å®šçš„â€œæœˆæ‰¿è¯ºé¢â€ï¼Œå¦‚éœ€è®¡å…¥å¯æŒ‰éœ€ä¿®æ”¹
        monthlyContribution = 0; 
    }

    return sum + monthlyContribution;
}, 0);

const finalTotal = totalAmt.toFixed(1);

// æ›´æ–° UI æ˜¾ç¤º
document.getElementById('anaTotalPromise').innerText = `Â¥ ${finalTotal.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;    

// 5. æ•°æ®èšåˆè¾…åŠ©å‡½æ•° (åŸºäºæ´»è·ƒæˆå‘˜)
    const aggregate = (key) => {
    return activeSupporters.reduce((obj, s) => {
        let label = s[key] || 'æœªçŸ¥';
        if (currentSupViewMode === 'count') {
            obj[label] = (obj[label] || 0) + 1;
        } else {
            // é‡‘é¢æ¨¡å¼ä¸‹ï¼Œä¹ŸæŒ‰æœˆåº¦æŠ˜ç®—
            let amt = parseFloat(s.amount) || 0;
            let m_amt = s.freq === 'æŒ‰å¹´' ? amt / 12 : (s.freq === 'æŒ‰æœˆ' ? amt : 0);
            obj[label] = (obj[label] || 0) + m_amt;
        }
        return obj;
    }, {});
};

    // 6. æ¸²æŸ“æ€§åˆ«åˆ†å¸ƒ (ç¯çŠ¶å›¾ + é”å®šé¢œè‰² + 0ä½å°æ•°ç™¾åˆ†æ¯”)
    const genderData = aggregate('gender');
    const genderLabels = Object.keys(genderData);
    const genderColors = genderLabels.map(label => {
        if (label === 'å¥³') return '#fb923c'; // æŸ”å’Œæ©™è‰²
        if (label === 'ç”·') return '#93c5fd'; // æŸ”å’Œè“è‰²
        return '#cbd5e1'; 
    });
    renderPie('chartGender', genderData, genderColors, true);

    // 7. æ¸²æŸ“æ”¯æŒé¢‘ç‡ (ç¯çŠ¶å›¾ + é»˜è®¤è‰² + 0ä½å°æ•°ç™¾åˆ†æ¯”)
    const freqData = aggregate('freq');
    renderPie('chartFreq', freqData, ['#6366f1', '#10b981', '#f59e0b'], true);

    // 8. æ¸²æŸ“åŸå¸‚åˆ†å¸ƒ (çºµå‘æŸ±çŠ¶å›¾ + çº¢ç»¿æ¸å˜ + æ— ç½‘æ ¼çº¿)
    const cityData = aggregate('city');
    renderCityBar('chartCity', cityData);

// åœ¨æ¸²æŸ“å®ŒåŸºç¡€æ•°æ®åï¼Œç«‹å³è®¡ç®—è¿›åº¦
calculateGoalProgress();
}



/**
 * æ¸²æŸ“çºµå‘æŸ±çŠ¶å›¾ï¼ˆçº¢ç»¿æ¸å˜ã€æ— ç½‘æ ¼çº¿ã€çºµåæ ‡æ•´æ•°ã€æ•°å­—+ç™¾åˆ†æ¯”æ˜¾ç¤ºï¼‰
 */
function renderCityBar(canvasId, data) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (supCharts[canvasId]) supCharts[canvasId].destroy();

    // æ•°æ®æ’åºå¹¶å–å‰ 8 å
    const sorted = Object.entries(data)
        .sort((a, b) => b[1] - a[1]) 
        .slice(0, 8);

    const labels = sorted.map(e => e[0]);
    const values = sorted.map(e => e[1]);

    // è°ƒç”¨å…¨å±€ getColors è®¡ç®—çº¢ç»¿æ¸å˜
    const barColors = getColors(values);

    supCharts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'äººæ•°',
                data: values,
                backgroundColor: barColors,
                borderRadius: 4,
                maxBarThickness: 40
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
            // åœ¨ renderCityBar çš„ options.plugins.tooltip.callbacks.label ä¸­ä¿®æ”¹ï¼š
label: function(context) {
    const rawValue = context.parsed.y || context.parsed; // å…¼å®¹æŸ±çŠ¶å›¾å’Œé¥¼å›¾
    const value = currentSupViewMode === 'count' ? Math.round(rawValue) : rawValue.toFixed(1);// å–æ•´
    const unit = currentSupViewMode === 'count' ? 'ä½' : 'å…ƒ';
    const displayValue = currentSupViewMode === 'count' ? value : 'Â¥' + value.toLocaleString();
    
    // è®¡ç®—ç™¾åˆ†æ¯”ä¿æŒä¸å˜
    const total = context.dataset.data.reduce((a, b) => a + b, 0);
    const percentage = ((rawValue / total) * 100).toFixed(0) + '%';
    
    return ` ${currentSupViewMode === 'count' ? 'æ•°é‡' : 'æœˆæŠ˜ç®—é¢'}: ${displayValue} ${unit} (${percentage})`;
}
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false }, // å·²å…³é—­ X è½´ç½‘æ ¼çº¿
                    border: { display: true }, // ä¿ç•™ X è½´åº•çº¿
                    ticks: { font: { size: 11 } }
                },
                y: {
                    beginAtZero: true,
                    // --- æ–°å¢ï¼šå…³é—­ Y è½´ç½‘æ ¼çº¿ ---
                    grid: { display: 1 }, 
                    // -----------------------
                    border: { display: 0 }, // å¦‚æœæƒ³å½»åº•å¹²æ‰å·¦ä¾§é‚£æ¡å‚ç›´çº¿ï¼Œè¿™é‡Œè®¾ä¸º false
                    ticks: {
                        // å¼ºåˆ¶æ­¥é•¿ä¸º 1ï¼ˆä»…åœ¨äººæ•°æ¨¡å¼ä¸‹ï¼‰
                        stepSize: currentSupViewMode === 'count' ? 1 : undefined,
                        // ç¡®ä¿ä¸æ˜¾ç¤ºå°æ•°ä½å¹¶å¤„ç†é‡‘é¢æ˜¾ç¤º
                        callback: function(value) {
                            if (currentSupViewMode === 'count') {
                                return value % 1 === 0 ? value : ''; 
                            }
                            // é‡‘é¢æ¨¡å¼ï¼šç¼©å†™å¤„ç† (1k, 2k...)
                            return value >= 1000 ? 'Â¥' + (value / 1000) + 'k' : 'Â¥' + value;
                        }
                    }
                }
            }
        }
    });
}


/**
 * æ¸²æŸ“ç¯çŠ¶å›¾ï¼ˆæ”¯æŒé”å®šé¢œè‰²ä¸ç™¾åˆ†æ¯”æ˜¾ç¤ºï¼‰
 */
function renderPie(canvasId, data, colors, isDoughnut = false) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (supCharts[canvasId]) supCharts[canvasId].destroy();
    
    supCharts[canvasId] = new Chart(ctx, {
        type: isDoughnut ? 'doughnut' : 'pie',
        data: {
            labels: Object.keys(data),
            datasets: [{
                data: Object.values(data),
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '50%',
            plugins: {
                legend: { 
                    position: 'bottom', 
                    labels: { boxWidth: 12, font: { size: 10 } } 
                },
                tooltip: {
                    callbacks: {
                        // --- æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†ï¼šå¤„ç†äººæ•°æ˜¾ç¤ºåˆ°ä¸ªä½ ---
                        label: function(context) {
                            const rawValue = context.raw; // è·å–åŸå§‹æ•°å€¼
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((rawValue / total) * 100).toFixed(0) + '%';
                            
                            let displayValue;
                            let unit;

                            if (currentSupViewMode === 'count') {
                                // äººæ•°æ¨¡å¼ï¼šå–æ•´ï¼Œä¸ä¿ç•™å°æ•°
                                displayValue = Math.round(rawValue); 
                                unit = 'ä½';
                                return ` æ•°é‡: ${displayValue} ${unit} (${percentage})`;
                            } else {
                                // é‡‘é¢æ¨¡å¼ï¼šä¿ç•™ä¸€ä½å°æ•°å¹¶æ ¼å¼åŒ–
                                displayValue = rawValue.toLocaleString(undefined, {
                                    minimumFractionDigits: 1,
                                    maximumFractionDigits: 1
                                });
                                unit = 'å…ƒ';
                                return ` æœˆæŠ˜ç®—é¢: Â¥${displayValue} ${unit} (${percentage})`;
                            }
                        }
                        // --- ä¿®æ”¹ç»“æŸ ---
                    }
                }
            }
        }
    });
}



let isSupShowAll = false; // æ”¯æŒè€…åˆ—è¡¨çš„æ˜¾ç¤ºçŠ¶æ€

function toggleSupShowAll() {
    isSupShowAll = !isSupShowAll;
    renderSupporters(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
}


let supporters = JSON.parse(localStorage.getItem('sup_members_v1')) || [];
    let records = JSON.parse(localStorage.getItem('sup_v14')) || [];
    let monthlyTarget = parseFloat(localStorage.getItem('sup_target')) || 0;
    let charts = {};

let isShowAll = false; // ç”¨äºåˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€

    const chartBase = {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { x: { grid: { display: false } }, y: { grid: { display: false }, beginAtZero: true } }
    };


document.getElementById('supporterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const member = {
        id: Date.now(),
        startDate: document.getElementById('supStartDate').value,
        endDate: document.getElementById('supEndDate').value,
        name: document.getElementById('supName').value.trim(),
        gender: document.getElementById('supGender').value,
        city: document.getElementById('supCity').value.trim(),
        freq: document.getElementById('supFreq').value,
        amount: parseFloat(document.getElementById('supAmount').value) || 0,
        remark: document.getElementById('supRemark').value.trim()
    };
    
    supporters.push(member);
    // æŒ‰å¼€å§‹æ—¥æœŸæ’åºï¼ˆå¯é€‰ï¼‰
    supporters.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
    
    saveSupporterData();
    
    // é‡ç½®è¡¨å•
    this.reset();
    
    // æ ¸å¿ƒï¼šå¼ºåˆ¶åˆ‡å› text ç±»å‹ä»¥æ˜¾ç¤ºâ€œå¼€å§‹æ—¥æœŸ/ç»“æŸæ—¥æœŸâ€é¢„è®¾æ–‡å­—
    document.getElementById('supStartDate').type = 'text';
    document.getElementById('supEndDate').type = 'text';
    
    alert("ä¿å­˜æˆåŠŸï¼");
});

/**
 * å¼ºåˆ¶æ˜¾ç¤ºæ”¯æŒè€…å§“ååˆ—è¡¨çš„æ‰€æœ‰é€‰é¡¹
 */
function forceShowAllSupporterNames(input) {
    updateSupNameList(); // å…ˆåˆ·æ–°åˆ—è¡¨
    const originalValue = input.value;
    input.value = ''; // ç¬é—´æ¸…ç©ºä»¥è¯±å¯¼æµè§ˆå™¨å¼¹å‡ºå…¨é‡åˆ—è¡¨
    
    const restoreValue = () => {
        if (input.value === '') {
            input.value = originalValue;
        }
        input.removeEventListener('blur', restoreValue);
    };
    input.addEventListener('blur', restoreValue);
    input.focus();
}

/**
 * ä»æ”¯æŒè€…åå†Œä¸­æå–æ‰€æœ‰å§“åå¹¶æ¸²æŸ“åˆ° datalist
 */
function updateSupNameList() {
    const nameList = document.getElementById('supNameList');
    if (!nameList) return;
    
    // æå–æ‰€æœ‰éç©ºå§“åå¹¶å»é‡
    const names = [...new Set(supporters.map(s => s.name).filter(n => n))];
    
    // æ¸²æŸ“åˆ° datalist
    nameList.innerHTML = names.map(name => `<option value="${name}">`).join('');
}

/**
 * å¼ºåˆ¶æ˜¾ç¤ºåŸå¸‚åˆ—è¡¨çš„æ‰€æœ‰é€‰é¡¹
 * @param {HTMLInputElement} input 
 */
function forceShowAllCities(input) {
    const originalValue = input.value;
    
    // 1. æ¸…ç©ºå½“å‰å€¼ï¼Œè¿™æ · datalist å°±ä¼šæ˜¾ç¤ºå…¨éƒ¨é€‰é¡¹
    input.value = '';
    
    // 2. è¿™é‡Œçš„ trick æ˜¯ï¼šå¦‚æœç”¨æˆ·ç›´æ¥ç‚¹å‡»åˆ«å¤„ï¼ˆæ²¡é€‰ï¼‰ï¼Œæˆ‘ä»¬è¦æŠŠæ—§å€¼å¡«å›å»
    const restoreValue = () => {
        if (input.value === '') {
            input.value = originalValue;
        }
        input.removeEventListener('blur', restoreValue);
    };
    
    input.addEventListener('blur', restoreValue);
    
    // 3. éƒ¨åˆ†æµè§ˆå™¨éœ€è¦æ‰‹åŠ¨èšç„¦
    input.focus();
}



// æ¸…ç©ºæ‰€æœ‰æ”¯æŒè€…æ•°æ®
function clearAllSupporters() {
    if (confirm("âš ï¸ è­¦å‘Šï¼šè¿™å°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰æ”¯æŒè€…åå†Œæ¡£æ¡ˆï¼Œæ— æ³•æ’¤é”€ï¼\næ“ä½œå‰å»ºè®®å…ˆå¤‡ä»½æ•°æ®ã€‚ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ")) {
        supporters = []; // æ¸…ç©ºæ•°ç»„
        
        // æ›´æ–°æœ¬åœ°å­˜å‚¨
        localStorage.removeItem('sup_members_v1'); 
        
        // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        renderSupporters();
        
        // å¦‚æœæœ‰è¡¨å•å†…å®¹ï¼Œä¹Ÿä¸€å¹¶é‡ç½®
        document.getElementById('supporterForm').reset();
        
        // æ¢å¤æ—¥æœŸè¾“å…¥æ¡†ç±»å‹
        document.getElementById('supStartDate').type = 'text';
        document.getElementById('supEndDate').type = 'text';
        
        alert("æ”¯æŒè€…æ¡£æ¡ˆå·²å…¨éƒ¨æ¸…ç©ºã€‚");
    }
}



// å¯¼å‡ºæ”¯æŒè€…æ¡£æ¡ˆä¸º CSV
function exportSupportersToCSV() {
    if (!supporters || supporters.length === 0) {
        alert("æ²¡æœ‰å¯å¯¼å‡ºçš„æ”¯æŒè€…æ•°æ®");
        return;
    }

    // 1. å®šä¹‰è¡¨å¤´
    const header = "\ufeffå¼€å§‹æ—¥æœŸ,ç»“æŸæ—¥æœŸ,å§“å,æ€§åˆ«,åŸå¸‚,é¢‘ç‡,é‡‘é¢,å¤‡æ³¨";

    // 2. æ•°æ®è½¬æ¢ä¸è½¬ä¹‰
    const rows = supporters.map(s => {
        const escape = (field) => {
            const str = String(field || '');
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };

        return [
            escape(s.startDate),
            escape(s.endDate),
            escape(s.name),
            escape(s.gender),
            escape(s.city),
            escape(s.freq),
            escape(s.amount.toFixed(2)),
            escape(s.remark)
        ].join(",");
    });

    const csvContent = header + "\n" + rows.join("\n");

    // 3. æ‰§è¡Œä¸‹è½½
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    
    // ç”Ÿæˆæ–‡ä»¶åï¼šYYYYMMDD_æ”¯æŒè€…åå†Œå¤‡ä»½.csv
    const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    a.href = url;
    a.download = `${dateStr}_æ”¯æŒè€…åå†Œå¤‡ä»½.csv`;
    
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}


// åœ¨ä¿å­˜æˆ–åŠ è½½æ•°æ®åè°ƒç”¨æ­¤é€»è¾‘
function refreshDatePlaceholders() {
    document.querySelectorAll('.date-input').forEach(input => {
        if (input.value) {
            input.setAttribute('placeholder', ' '); // è§¦å‘ CSS ä¸­çš„ :not(:placeholder-shown)
        } else {
            input.removeAttribute('placeholder');
        }
    });
}




function saveSupporterData() {
    console.log("æ­£åœ¨åŒæ­¥æ•°æ®å¹¶åˆ·æ–°ç”»åƒ..."); // è°ƒè¯•æ—¥å¿—
    
    // 1. æ ‡å‡†åŒ–æ—¥æœŸ
    supporters.forEach(s => {
        s.startDate = formatDateStandard(s.startDate);
        s.endDate = formatDateStandard(s.endDate);
    });

    // 2. æ’åº
    supporters.sort((a, b) => {
        const timeA = a.startDate ? new Date(a.startDate.replace(/-/g, '/')).getTime() : 0;
        const timeB = b.startDate ? new Date(b.startDate.replace(/-/g, '/')).getTime() : 0;
        return timeB - timeA; 
    });

    // 3. æ°¸ä¹…ä¿å­˜
    localStorage.setItem('sup_members_v1', JSON.stringify(supporters));

    // 4. ç•Œé¢å…¨é‡å®æ—¶åˆ·æ–°
    renderSupporters();           // åˆ·æ–°åå†Œè¡¨æ ¼å†…å®¹
    updateSupCityList();          // åˆ·æ–°åŸå¸‚ä¸‹æ‹‰åˆ—è¡¨
    updateSupNameList();          // åˆ·æ–°å§“åä¸‹æ‹‰åˆ—è¡¨
    
    // å…³é”®ï¼šå¼ºåˆ¶åˆ·æ–°ç”»åƒåˆ†ææ¨¡å—
    if (typeof renderSupporterAnalysis === 'function') {
        renderSupporterAnalysis(); 
    }
}




function updateSupCityList() {
    const cityList = document.getElementById('supCityList');
    if (!cityList) return;
    
    // ä»æ”¯æŒè€…åå†Œä¸­æå–æ‰€æœ‰éç©ºçš„åŸå¸‚ï¼Œå¹¶å»é‡
    const cities = [...new Set(supporters.map(s => s.city).filter(c => c))];
    
    // æ¸²æŸ“åˆ° datalist
    cityList.innerHTML = cities.map(city => `<option value="${city}">`).join('');
}



function renderSupporters() {
    const body = document.getElementById('supporterBody');
    const btn = document.getElementById('btnSupShowAll');
    const countSpan = document.getElementById('supRecordCount'); 
    
    // --- å†…éƒ¨æ—¥æœŸæ ‡å‡†åŒ–å·¥å…·ï¼šè¡¥å…¨ yyyy-mm-dd ---
    const formatDate = (dateStr) => {
        if (!dateStr || dateStr.trim() === "") return '-';
        // å…¼å®¹å¤„ç†ï¼šæ–œæ è½¬æ¨ªæ ï¼Œå¹¶å°è¯•è§£æ
        const d = new Date(dateStr.replace(/-/g, '/')); 
        if (isNaN(d.getTime())) return dateStr; 
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    };

    if(countSpan) {
        countSpan.innerText = `(å…± ${supporters.length} ä½)`;
    }

    const displayList = isSupShowAll ? supporters : supporters.slice(0, 10);
    
    if(btn) {
        btn.innerText = isSupShowAll ? "æ”¶èµ·è®°å½•" : "æ˜¾ç¤ºå…¨éƒ¨è®°å½•";
    }

    body.innerHTML = displayList.map((s, index) => {
        // åˆ¤æ–­çŠ¶æ€æ—¶ä¹Ÿéœ€è¦æ ‡å‡†åŒ–çš„æ—¥æœŸå¯¹è±¡
        const isActive = !s.endDate || new Date(s.endDate.replace(/-/g, '/')) > new Date();
        return `
            <tr>
                <td style="color: #64748b;">${formatDate(s.startDate)}</td>
                <td><b>${s.name}</b></td>
                <td>${s.gender}</td>
                <td>${s.city}</td>
                <td>${s.freq}</td>
                <td>Â¥${s.amount.toFixed(2)}</td>
                <td>${isActive ? '<span style="color:var(--success)">æ”¯æŒä¸­</span>' : '<span style="color:#94a3b8">å·²ç»“æŸ</span>'}</td>
                <td style="text-align:center">
                    <a href="javascript:void(0)" onclick="editSupporter(${index})" style="color:var(--primary); margin-right:8px; text-decoration:none; font-weight:bold;">ç¼–è¾‘</a>
                    <a href="javascript:void(0)" onclick="deleteSupporter(${index})" style="color:var(--danger); text-decoration:none; font-weight:bold;">åˆ é™¤</a>
                </td>
            </tr>
        `;
    }).join('');

    updateSupCityList();
}





function formatDateStandard(dateStr) {
    if (!dateStr) return '';
    // å°†æ‰€æœ‰ / æ›¿æ¢ä¸º -
    let cleanStr = dateStr.replace(/\//g, '-');
    let parts = cleanStr.split('-');
    
    if (parts.length === 3) {
        let y = parts[0];
        let m = parts[1].padStart(2, '0'); // è¡¥é½ä¸¤ä½æ•°
        let d = parts[2].padStart(2, '0'); // è¡¥é½ä¸¤ä½æ•°
        return `${y}-${m}-${d}`;
    }
    return dateStr;
}







function editSupporter(index) {
    const s = supporters[index];
    
    // 1. å›å¡«åŸºæœ¬ä¿¡æ¯
    document.getElementById('supName').value = s.name;
    document.getElementById('supGender').value = s.gender;
    document.getElementById('supCity').value = s.city;
    document.getElementById('supFreq').value = s.freq;
    document.getElementById('supAmount').value = s.amount;
    document.getElementById('supRemark').value = s.remark;
    
    // 2. å¤„ç†æ—¥æœŸå›å¡«ï¼ˆå¤„ç†ä¹‹å‰æåˆ°çš„ç±»å‹åˆ‡æ¢é€»è¾‘ï¼‰
    const startInput = document.getElementById('supStartDate');
    const endInput = document.getElementById('supEndDate');
    
    if (s.startDate) {
        startInput.type = 'date';
        startInput.value = s.startDate;
    }
    if (s.endDate) {
        endInput.type = 'date';
        endInput.value = s.endDate;
    }

    // 3. ä»æ•°ç»„ä¸­ç§»é™¤å½“å‰é¡¹ï¼ˆä»¥ä¾¿ä¿å­˜æ—¶ä½œä¸ºæ–°æ•°æ®å­˜å…¥ï¼Œæˆ–è€…ä½ å¯ä»¥å¢åŠ ä¸€ä¸ªå…¨å±€å˜é‡ editIndex æ¥æ ‡è®°ï¼‰
    supporters.splice(index, 1);
    
    // 4. æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨æ–¹ä¾¿ç¼–è¾‘
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    renderSupporters(); // åˆ·æ–°åˆ—è¡¨æŸ¥çœ‹æ•ˆæœ
}

// 4. åˆ é™¤æ”¯æŒè€…
function deleteSupporter(index) {
    if(confirm("ç¡®å®šåˆ é™¤è¯¥æ”¯æŒè€…æ¡£æ¡ˆå—ï¼Ÿ")) {
        supporters.splice(index, 1);
        saveSupporterData();
    }
}



function exportToGaomingCSV() {
    if (!records || records.length === 0) {
        alert("æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®");
        return;
    }

    // --- æ ¸å¿ƒï¼šå†…éƒ¨æ—¥æœŸæ ¼å¼åŒ–è¾…åŠ©å·¥å…· ---
    const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const d = new Date(dateStr.replace(/-/g, '/')); // å…¼å®¹æ€§è§£æ
        if (isNaN(d.getTime())) return dateStr; 
        
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    };

    // 1. å®šä¹‰è¡¨å¤´
    const header = "\ufeffæ—¥æœŸ,é‡‘é¢,ç§ç±»,æ”¯æŒè€…,æè¿°";

    // 2. æ•°æ®è½¬æ¢é€»è¾‘
    const rows = records.map(r => {
        // è½¬æ¢ç§ç±»ï¼šæŒ‰æœˆ -> Monthlyï¼Œå…¶ä»– -> One-time
        const type = (r.frequency === 'æŒ‰æœˆ') ? 'Monthly' : 'One-time';
        
        const escape = (field) => {
            const str = String(field || '');
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };

        return [
            escape(formatDate(r.date)), // <--- è¿™é‡Œå¼ºåˆ¶æ ¼å¼åŒ–ä¸º yyyy-mm-dd
            escape(r.amount.toFixed(2)),
            escape(type),
            escape(r.name),
            escape(r.remark)
        ].join(",");
    });

    const csvContent = header + "\n" + rows.join("\n");

    // 3. æ‰§è¡Œä¸‹è½½
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    
    const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    a.href = url;
    a.download = `${dateStr}_é«˜æ˜æ ¼å¼æ”¯æŒè¡¨.csv`;
    
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}


function downloadTemplate(event) {
    if (event) event.preventDefault(); // é˜²æ­¢é¡µé¢è·³è½¬

    // 1. å®šä¹‰è¡¨å¤´ï¼šå¿…é¡»ä¸ exportToCSV å‡½æ•°ä¸­çš„åˆ—åºå®Œå…¨ä¸€è‡´
    // åŒ…å«ï¼šæ—¥æœŸ, å§“å, æ€§åˆ«, æ–¹å¼, åœ°åŒº, é‡‘é¢, é¢‘ç‡, å¤‡æ³¨
    const header = "\ufeffæ—¥æœŸ,å§“å,æ€§åˆ«,æ–¹å¼,åœ°åŒº,é‡‘é¢,é¢‘ç‡,å¤‡æ³¨\n";
    
    // 2. å®šä¹‰ç¤ºä¾‹è¡Œï¼šæ–¹ä¾¿ç”¨æˆ·å‚è€ƒæ ¼å¼å½•å…¥
    const example = "2026-01-20,å¼ ä¸‰,ç”·,å¾®ä¿¡,ä¸Šæµ·,100.00,æŒ‰æœˆ,æ—¥å¸¸æ”¯æŒ\n";
    
    const csvContent = header + example;

    // 3. åˆ›å»º Blob å¯¹è±¡ï¼ˆæŒ‡å®šç¼–ç ä¸º UTF-8 å¸¦æœ‰ BOMï¼Œç¡®ä¿ Excel æ‰“å¼€ä¸ä¹±ç ï¼‰
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    
    // 4. åˆ›å»ºéšè—çš„ä¸‹è½½é“¾æ¥å¹¶è§¦å‘
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", "æ”¯æŒè®°å½•å¯¼å…¥æ¨¡ç‰ˆ.csv");
    document.body.appendChild(link);
    
    link.click();
    
    // 5. æ¸…ç†ç°åœº
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}


function forceShowAll(input) {
    // åªæœ‰å½“æ¡†å†…æœ‰å†…å®¹æ—¶æ‰æ‰§è¡Œç‰¹æ®Šé€»è¾‘
    if (input.value !== '') {
        const originalValue = input.value;
        input.value = ''; // ç¬é—´æ¸…ç©ºï¼Œè¯±å¯¼æµè§ˆå™¨å¼¹å‡ºå…¨é‡ datalist
        
        // ç›‘å¬ä¸‹ä¸€æ¬¡è¾“å…¥æˆ–å¤±å»ç„¦ç‚¹ï¼Œå¦‚æœç”¨æˆ·æ²¡é€‰æ–°å€¼ï¼Œå°±è¿˜åŸæ—§å€¼
        const restoreValue = () => {
            if (input.value === '') {
                input.value = originalValue;
            }
            input.removeEventListener('blur', restoreValue);
        };
        input.addEventListener('blur', restoreValue);
    }
}

    // --- æ ¸å¿ƒä¿®å¤ï¼šCSV å¯¼å…¥å¼•æ“ ---
    document.getElementById('fileInput').addEventListener('change', function(e) {
        if (this.files[0]) processFile(this.files[0]);
    });

document.getElementById('dropZone').addEventListener('click', function() {
    document.getElementById('fileInput').click();
});

    function processFile(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            // å…¼å®¹å¤šç§æ¢è¡Œç¬¦å¹¶è¿‡æ»¤ç©ºè¡Œ
            const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
            let count = 0;



            lines.forEach((line, i) => {
    if (i === 0) return; // è·³è¿‡è¡¨å¤´
    const cols = line.split(',').map(c => c.replace(/^["']|["']$/g, '').trim());
    
    if (cols.length >= 4 && !isNaN(parseFloat(cols[3]))) {
        const dStr = cols[0];
        const ts = new Date(dStr.replace(/-/g,'/')).getTime();
        if (!isNaN(ts)) {
            records.push({
                date: dStr,
                name: cols[1],
                area: cols[2],
                amount: parseFloat(cols[3]),
                frequency: cols[4] || '', // æ–°å¢ï¼šè¯»å–ç¬¬5åˆ— é¢‘ç‡
                remark: cols[5] || '',    // æ–°å¢ï¼šè¯»å–ç¬¬6åˆ— å¤‡æ³¨
                ts: ts
            });
            count++;
        }
    }
});



            if (count > 0) {
                records.sort((a,b) => b.ts - a.ts);
                saveData();
                alert(`å¯¼å…¥æˆåŠŸï¼å…±æ–°å¢ ${count} æ¡è®°å½•ã€‚`);
            } else {
                alert("æœªæ£€æµ‹åˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥ CSV æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚");
            }
            document.getElementById('fileInput').value = ""; // é‡ç½®æ–‡ä»¶é¡¹
        };
        reader.onerror = () => alert("è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚");
        reader.readAsText(file, 'UTF-8');
    }

    // --- å…¶ä»–åŠŸèƒ½ç»´æŠ¤ ---
   function handleDrag(e, over, id) { 
    e.preventDefault(); 
    e.stopPropagation(); 
    document.getElementById(id).classList.toggle('dragover', over); 
}

function handleSupDrop(e) { 
    e.preventDefault(); e.stopPropagation(); 
    handleDrag(e, false, 'supDropZone'); 
    if (e.dataTransfer.files[0]) processSupFile(e.dataTransfer.files[0]); 
}


function processSupFile(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        // 1. å…¼å®¹å¤šç§æ¢è¡Œç¬¦å¹¶è¿‡æ»¤ç©ºè¡Œ
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
        let count = 0;

        lines.forEach((line, i) => {
            if (i === 0) return; // è·³è¿‡è¡¨å¤´
            
            // 2. ç®€å•çš„ CSV è§£æï¼ˆå¤„ç†é€—å·åˆ†éš”ï¼‰
            const cols = line.split(',').map(c => c.replace(/^["']|["']$/g, '').trim());
            
            // 3. æ ¡éªŒå§“åå’Œæ—¥æœŸï¼ˆè‡³å°‘è¦æœ‰ç¬¬3åˆ—å§“åå’Œç¬¬1åˆ—å¼€å§‹æ—¥æœŸï¼‰
            if (cols.length >= 3 && cols[2]) { 
                supporters.push({
                    id: Date.now() + i,
                    startDate: formatDateStandard(cols[0]),
                    endDate: formatDateStandard(cols[1]) || '',
                    name: cols[2],
                    gender: cols[3] || 'ç”·',
                    city: cols[4] || '',
                    freq: cols[5] || 'æŒ‰æœˆ',
                    amount: parseFloat(cols[6]) || 0,
                    remark: cols[7] || ''
                });
                count++;
            }
        });

        // 4. ä¿å­˜å¹¶åé¦ˆ
        if (count > 0) {
            saveSupporterData(); // è¯¥å‡½æ•°ä¼šè‡ªåŠ¨è§¦å‘ renderSupporters å’Œ renderSupporterAnalysis
            alert(`æ”¯æŒè€…åå†Œå¯¼å…¥æˆåŠŸï¼å…±æ–°å¢ ${count} ä½æˆå‘˜ã€‚`);
        } else {
            alert("æœªæ£€æµ‹åˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥ CSV æ ¼å¼ã€‚");
        }
        document.getElementById('supFileInput').value = ""; // æ¸…ç©º input æ–¹ä¾¿é‡å¤å¯¼å…¥
    };
    reader.onerror = () => alert("è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç¼–ç ï¼ˆå»ºè®®ä½¿ç”¨ UTF-8ï¼‰ã€‚");
    reader.readAsText(file, 'UTF-8');
}


function downloadSupTemplate() {
    const header = "\ufeffå¼€å§‹æ”¯æŒæ—¥æœŸ,ç»“æŸæ”¯æŒæ—¥æœŸ,å§“å,æ€§åˆ«,åŸå¸‚,é¢‘ç‡,é‡‘é¢,å¤‡æ³¨\n";
    const example = "2024-01-01,,å¼ ä¸‰,ç”·,ä¸Šæµ·,æŒ‰æœˆ,500,æ ¸å¿ƒæ”¯æŒè€…\n";

    const csvContent = header + example;

    const blob = new Blob([header + example], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);


    const link = document.createElement("a");

 link.setAttribute("href", url);
    link.setAttribute("download", "æ”¯æŒåå†Œå¯¼å…¥æ¨¡ç‰ˆ.csv");
    document.body.appendChild(link);
    
    link.click();
 document.body.removeChild(link);
    URL.revokeObjectURL(url);
}



// ä¿®æ”¹ showPage å‡½æ•°

function showPage(p) {
    localStorage.setItem('current_active_page', p);
    window.scrollTo({ top: 0, behavior: 'instant' });
    
    const mainTitle = document.getElementById('mainTitle');
    const navHeader = document.querySelector('.nav-header');
    const indexPage = document.getElementById('indexPage');
    
    // è·å–æ‰€æœ‰æŒ‰é’®
    const btnToHome = document.getElementById('toHome');
    const btnToSupporter = document.getElementById('toSupporter');
    const btnToIndex = document.getElementById('toIndex');

    // 1. å…ˆéšè—æ‰€æœ‰å¯¼èˆªæ æŒ‰é’®ï¼Œé˜²æ­¢â€œå¤šä½™å†…å®¹â€å‡ºç°
    [btnToHome, btnToSupporter, btnToIndex].forEach(btn => {
        if(btn) btn.classList.add('hidden');
    });

    // 2. å¤„ç†é—¨æˆ·é¦–é¡µæ˜¾éš
    if (p === 'index') {
        navHeader.classList.add('hidden');
        indexPage.style.display = 'flex';
        
        // --- å¼ºåŒ–é€»è¾‘ï¼šä¸ç®¡æ ‡ç­¾åµŒå¥—å¯¹ä¸å¯¹ï¼Œå¼ºåˆ¶éšè—æ‰€æœ‰å¯èƒ½éœ²å‡ºçš„å®¹å™¨ ---
        document.getElementById('homePage').classList.add('hidden');
        document.getElementById('supporterPage').classList.add('hidden');
        document.getElementById('analysisPage').classList.add('hidden');
        document.getElementById('supporterAnalysisPage').classList.add('hidden');
        // -------------------------------------------------------
        
        return; 
    } else {
        navHeader.classList.remove('hidden');
        indexPage.style.display = 'none';
    }

    // 3. åˆ‡æ¢é¡µé¢å®¹å™¨æ˜¾ç¤º
    const pages = ['home', 'analysis', 'supporter', 'supporterAnalysisPage'];
    pages.forEach(id => {
        const el = document.getElementById(id + (id.includes('Page') ? '' : 'Page'));
        if (el) el.classList.toggle('hidden', id !== p);
    });

    // 4. --- ç²¾å‡†æ˜¾ç¤ºæŒ‰é’® (æ ¸å¿ƒä¿®å¤ç‚¹) ---
    if (p === 'home') {
        mainTitle.innerText = "æ”¯æŒè®°å½•ç³»ç»Ÿ";
        btnToIndex.classList.remove('hidden'); // åªç•™è¿”å›é¦–é¡µ
        renderHome();
    } 
    else if (p === 'supporter') {
        mainTitle.innerText = "æ”¯æŒè€…ç®¡ç†ç³»ç»Ÿ";
        btnToIndex.classList.remove('hidden'); // åªç•™è¿”å›é¦–é¡µ
        renderSupporters();
    }
    else if (p === 'analysis') {
        mainTitle.innerText = "è´¢åŠ¡åˆ†æä¸­å¿ƒ";
        btnToHome.classList.remove('hidden'); // ä¿æŒåŸæœ‰ï¼šå›æ”¯æŒè®°å½•
        runAnalysis();
    }
    else if (p === 'supporterAnalysisPage') {
        mainTitle.innerText = "æ”¯æŒè€…ç”»åƒåˆ†æ";
        btnToSupporter.classList.remove('hidden'); // ä¿æŒåŸæœ‰ï¼šå›åå†Œ
        btnToSupporter.innerText = "ğŸ‘¥ è¿”å›åå†Œ";
        setTimeout(renderSupporterAnalysis, 100);
    }
}

    function saveData() { localStorage.setItem('sup_v14', JSON.stringify(records)); renderHome(); }
    
   function renderHome() {
    const body = document.getElementById('recordBody');
    const displayList = isShowAll ? records : records.slice(0, 10);
    
    // æ›´æ–°æŒ‰é’®æ–‡å­—å’Œè®¡æ•°
    document.getElementById('btnShowAll').innerText = isShowAll ? "æ”¶èµ·è®°å½•" : "æ˜¾ç¤ºå…¨éƒ¨";
    document.getElementById('recordCount').innerText = `(å…± ${records.length} æ¡)`;

    // --- æ–°å¢ï¼šå†…éƒ¨æ—¥æœŸæ ¼å¼åŒ–å·¥å…· ---
    const formatDate = (dateStr) => {
        if (!dateStr) return '-';
        const d = new Date(dateStr.replace(/-/g, '/')); // å…¼å®¹æ€§è§£æ
        if (isNaN(d.getTime())) return dateStr; 
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    };

    // ä¿®æ”¹æ¸²æŸ“éƒ¨åˆ†
   body.innerHTML = displayList.map((r, index) => `
    <tr>
        <td>${formatDate(r.date)}</td>
        <td><b>${r.name}</b></td>
        <td>${r.gender || '-'}</td> <td>${r.method || '-'}</td> <td>${r.area}</td>
        <td>Â¥${r.amount.toFixed(2)}</td>
        <td><small>${r.frequency || '-'}</small></td> 
        <td title="${r.remark || ''}">${(r.remark || '-').substring(0,10)}</td> 
        <td style="text-align:right">
            <a href="javascript:void(0)" onclick="editRecord(${index})" style="color:var(--primary); margin-right:10px; text-decoration:none;">ç¼–è¾‘</a>
            <a href="javascript:void(0)" onclick="deleteRecord(${index})" style="color:var(--danger); text-decoration:none;">åˆ é™¤</a>
        </td>
    </tr>
`).join('');

    // æ›´æ–°è‡ªåŠ¨è¡¥å…¨åˆ—è¡¨
    document.getElementById('nameList').innerHTML = [...new Set(records.map(r => r.name))].map(n => `<option value="${n}">`).join('');
    document.getElementById('areaList').innerHTML = [...new Set(records.map(r => r.area))].map(a => `<option value="${a}">`).join('');
    document.getElementById('methodList').innerHTML = [...new Set(records.map(r => r.method).filter(x=>x))].map(m => `<option value="${m}">`).join('');
}
   



document.getElementById('recordForm').addEventListener('submit', function(e){
    e.preventDefault();
    const d = document.getElementById('date').value;
    records.push({ 
        date: d, 
        name: document.getElementById('name').value.trim(), 
        gender: document.getElementById('gender').value.trim(), // æ–°å¢
        method: document.getElementById('method').value.trim(), // æ–°å¢
        area: document.getElementById('area').value.trim(), 
        amount: parseFloat(document.getElementById('amount').value),
        frequency: document.getElementById('frequency').value,
        remark: document.getElementById('remark').value.trim(),
        ts: new Date(d.replace(/-/g,'/')).getTime() 
    });
    records.sort((a,b) => b.ts - a.ts); 
    saveData(); 
    this.reset();
});





// åˆ‡æ¢æ˜¾ç¤ºå…¨éƒ¨
function toggleShowAll() {
    isShowAll = !isShowAll;
    renderHome();
}

// åˆ é™¤å•æ¡è®°å½•
function deleteRecord(index) {
    if (confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) {
        records.splice(index, 1);
        saveData();
    }
}

// ç¼–è¾‘è®°å½•
// ç¼–è¾‘åŠŸèƒ½ä¿®å¤ç‰ˆ
function editRecord(index) {
    const r = records[index];
    
    // 1. æ ¸å¿ƒä¿®å¤ï¼šæ ‡å‡†åŒ–æ—¥æœŸæ ¼å¼ä¸º YYYY-MM-DD
    const dateObj = new Date(r.date.replace(/-/g, '/')); // å…¼å®¹ä¸åŒæµè§ˆå™¨çš„è§£æ
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth() + 1).padStart(2, '0');
    const d = String(dateObj.getDate()).padStart(2, '0');
    const formattedDate = `${y}-${m}-${d}`;

    // 2. å›å¡«æ•°æ®
   document.getElementById('date').value = formattedDate;
    document.getElementById('name').value = r.name;
    document.getElementById('area').value = r.area;
    document.getElementById('amount').value = r.amount;
    document.getElementById('frequency').value = r.frequency || ''; // æ–°å¢
    document.getElementById('remark').value = r.remark || '';      // æ–°å¢
    document.getElementById('gender').value = r.gender || ''; // æ–°å¢å›å¡«
    document.getElementById('method').value = r.method || ''; // æ–°å¢å›å¡«
    
    records.splice(index, 1);
    window.scrollTo({ top: 0, behavior: 'smooth' });
    renderHome();
}

// æ¸…ç©ºæ‰€æœ‰æ•°æ®
function clearAllData() {
    if (confirm("âš ï¸ è­¦å‘Šï¼šè¿™å°†æ°¸ä¹…åˆ é™¤æœ¬åœ°æ‰€æœ‰è®°å½•ï¼Œå»ºè®®æ“ä½œå‰å…ˆç‚¹å‡»å¯¼å‡º CSV å¤‡ä»½ã€‚ç¡®å®šæ¸…ç©ºå—ï¼Ÿ")) {
        records = [];
        saveData();
        alert("æ•°æ®å·²æ¸…ç©º");
    }
}

    // --- åˆ†æä¸­å¿ƒé€»è¾‘ä¿®å¤ ---
    function getTimeline() {
        const res = []; const now = new Date();
        for(let i=11; i>=0; i--) {
            const s = new Date(now.getFullYear(), now.getMonth()-i, 1);
            const e = new Date(now.getFullYear(), now.getMonth()-i+1, 1);
            res.push({ label: `${s.getFullYear()}-${(s.getMonth()+1).toString().padStart(2,'0')}`, start: s.getTime(), end: e.getTime() });
        }
        return res;
    }

    function updateDimensionChart() {
        const dim = document.getElementById('vDimension').value;
        const range = document.getElementById('vRange').value;
        const timeline = getTimeline();
        const startTime = range === 'year' ? new Date(new Date().getFullYear(), 0, 1).getTime() : timeline[0].start;
        
        // 1. æ•°æ®è¿‡æ»¤
        const filtered = records.filter(r => r.ts >= startTime);
        
        let labels = [], vals = [];
        let isHorizontal = true; // é»˜è®¤æ’åç±»ä½¿ç”¨æ¨ªå‘æŸ±çŠ¶å›¾

        if (dim === 'person' || dim === 'city') {
            // 2. èšåˆæ•°æ®
            let map = {};
            filtered.forEach(r => { 
                const key = dim === 'person' ? r.name : r.area; 
                map[key] = (map[key] || 0) + r.amount; 
            });

            // 3. ä¿®å¤æ’åºï¼šä»å¤§åˆ°å°æ’åˆ—ï¼Œå¹¶å– Top 15 é¿å…æ•°æ®æ˜¾ç¤ºæ‹¥æŒ¤
            const sorted = Object.entries(map).sort((a, b) => b[1] - a[1]).slice(0, 15);
            labels = sorted.map(e => e[0]);
            vals = sorted.map(e => e[1]);
            isHorizontal = true; 
        } else {
            // 4. æ—¶é—´è¶‹åŠ¿é€»è¾‘
            isHorizontal = false; // æ—¶é—´è¶‹åŠ¿ä½¿ç”¨çºµå‘æŸ±çŠ¶å›¾
            if (range === 'year') {
                labels = Array.from({length: 12}, (_, i) => (i + 1) + 'æœˆ');
                vals = Array(12).fill(0);
                filtered.forEach(r => {
                    const m = new Date(r.ts).getMonth();
                    if (vals[m] !== undefined) vals[m] += r.amount;
                });
            } else {
                labels = timeline.map(t => t.label);
                vals = timeline.map(t => filtered.filter(r => r.ts >= t.start && r.ts < t.end).reduce((s, r) => s + r.amount, 0));
            }
        }

        // 5. æ›´æ–°å›¾è¡¨
        const ctx = document.getElementById('vBarChart').getContext('2d');
        if (charts.v) charts.v.destroy();
        
        charts.v = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'æ”¯æŒé‡‘é¢',
                    data: vals,
                    backgroundColor: getColors(vals),
                    borderRadius: 6
                }]
            },
            options: {
                ...chartBase,
                indexAxis: isHorizontal ? 'y' : 'x', // åŠ¨æ€åˆ‡æ¢æ¨ªçºµè½´
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => ` Â¥${context.parsed[isHorizontal ? 'x' : 'y'].toFixed(2)}`
                        }
                    }
                },
                scales: {
                    x: { 
                        grid: { display: false },
                        beginAtZero: true,
                        ticks: { font: { size: 10 } }
                    },
                    y: { 
                        grid: { display: false },
                        ticks: { font: { size: 11 } }
                    }
                }
            }
        });
    }

    function updateGoals() {
        monthlyTarget = parseFloat(document.getElementById('monthlyTargetInput').value) || 0;
        localStorage.setItem('sup_target', monthlyTarget);

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šç»Ÿä¸€å­˜å‚¨é”®å ---
    localStorage.setItem('sup_manual_goal', monthlyTarget); 
    // ----------------------------

    document.getElementById('annualTargetDisplay').innerText = `Â¥ ${(monthlyTarget * 12).toFixed(2)}`;


        document.getElementById('annualTargetDisplay').innerText = `Â¥ ${(monthlyTarget * 12).toFixed(2)}`;
        
        const timeline = getTimeline();
        const actuals = timeline.map(t => records.filter(r => r.ts >= t.start && r.ts < t.end).reduce((s,r)=>s+r.amount,0));
        const avg = actuals.reduce((a,b)=>a+b, 0) / 12;
        const rate = monthlyTarget > 0 ? (avg / monthlyTarget * 100) : 0;
        const gap = monthlyTarget - avg;

        document.getElementById('avgMonthlyAmt').innerText = `Â¥ ${avg.toFixed(2)}`;
        document.getElementById('avgAchievement').innerText = `${rate.toFixed(1)}%`;
        document.getElementById('avgGap').innerText = (gap > 0 ? 'Â¥ ' : '- Â¥ ') + Math.abs(gap).toFixed(2);
        document.getElementById('avgGap').style.color = gap <= 0 ? 'var(--success)' : 'var(--danger)';
        
        const yearActual = records.filter(r => r.date.startsWith(new Date().getFullYear())).reduce((s,r)=>s+r.amount,0);
        document.getElementById('annualProgressText').innerText = monthlyTarget > 0 ? `${(yearActual / (monthlyTarget*12) * 100).toFixed(1)}%` : "0%";

        const ctxM = document.getElementById('monthlyGoalChart').getContext('2d');
        if(charts.goalM) charts.goalM.destroy();
        charts.goalM = new Chart(ctxM, {
            type: 'bar',
            data: { 
                labels: timeline.map(t => t.label),
                datasets: [
                    { label: 'å®é™…ç­¹æ¬¾', data: actuals, backgroundColor: actuals.map(v => v >= monthlyTarget ? '#f97316':'#22c55e'), borderRadius: 4 },
                    { label: 'ç­¹æ¬¾ç›®æ ‡', data: Array(12).fill(monthlyTarget), type: 'line', borderColor: '#6366f1', borderDash: [5, 5], pointRadius: 0 }
                ]
            },
            options: { ...chartBase, plugins: { title: { display:true, text:'12ä¸ªæœˆç›®æ ‡è¾¾æˆå¯¹æ¯”' } } }
        });
    }

  


function analyzePerson() {
    const name = document.getElementById('pSearch').value;
    const pRecs = records.filter(r => r.name === name);
    const reminderDiv = document.getElementById('pReminder');
    const now = new Date();

    if(!pRecs.length) { 
        document.getElementById('pStats').style.display='none'; 
        return; 
    }

    document.getElementById('pStats').style.display = 'grid';

    // 1. è·å–åå†Œä¸­çš„æ‰¿è¯ºé‡‘é¢
    const supporterProfile = supporters.find(s => s.name === name);
    let promiseText = "æœªè®¾å®š";
    if (supporterProfile) {
        const rawAmt = parseFloat(supporterProfile.amount) || 0;
        if (supporterProfile.freq === 'æŒ‰æœˆ') promiseText = `Â¥ ${rawAmt.toFixed(1)}`;
        else if (supporterProfile.freq === 'æŒ‰å¹´') promiseText = `Â¥ ${(rawAmt / 12).toFixed(1)}`;
        else if (supporterProfile.freq === 'ä¸å®šæœŸ') promiseText = "ä¸å®šæœŸ";
    }
    document.getElementById('pMonthlyPromise').innerText = promiseText;

    // 2. è®¡ç®—æœ¬å¹´åº¦æœˆå¹³å‡ (åªç»Ÿè®¡å½“å¹´çš„æ•°æ®é™¤ä»¥ 12)
    const currentYear = now.getFullYear();
    const yearStart = new Date(currentYear, 0, 1).getTime();
    const thisYearTotal = pRecs.filter(r => r.ts >= yearStart).reduce((s,r) => s + r.amount, 0);
    document.getElementById('pAvgYearly').innerText = `Â¥ ${(thisYearTotal / 12).toFixed(2)}`;

    // 3. åŸæœ‰åŸºç¡€ç»Ÿè®¡ (ç´¯è®¡å’Œæœ€è¿‘)
    const totalAmt = pRecs.reduce((s,r) => s + r.amount, 0);
    const last = [...pRecs].sort((a,b) => b.ts - a.ts)[0];
    document.getElementById('pTotalAmount').innerText = `Â¥ ${totalAmt.toFixed(2)}`;
    document.getElementById('pLastRecord').innerText = `${last.date} (Â¥${last.amount})`;

    // æ¸©é¦¨æé†’å’Œå›¾è¡¨æ¸²æŸ“ä¿æŒä¸å˜...
    const daysDiff = Math.floor((now.getTime() - last.ts) / (1000 * 60 * 60 * 24));
    reminderDiv.innerHTML = daysDiff > 60 ? 
        `<div class="alert-box alert-warn">âš ï¸ å·²æœ‰ ${daysDiff} å¤©æœªæ”¯æŒï¼Œå¯ä»¥ä¸»åŠ¨å…³å¿ƒä¸€ä¸‹å“¦ï¼â¤ï¸</div>` : 
        `<div class="alert-box alert-heart">âœ¨ æœ€è¿‘æ”¯æŒåœ¨ ${daysDiff} å¤©å‰ï¼Œå¯ä»¥é—®å€™æ„Ÿè°¢ä¸€ä¸‹å“¦ï¼ğŸ‰</div>`;

    renderPersonChart(pRecs, supporterProfile);
}

// å»ºè®®å°†å›¾è¡¨æ¸²æŸ“æ‹†åˆ†ï¼Œä¿æŒä»£ç æ•´æ´
function renderPersonChart(pRecs, supporterProfile) {
    const range = document.getElementById('pRange').value;
    let labels = [], vals = [];
    const now = new Date();
    const currentYear = now.getFullYear();

    if (range === 'yearly') {
        // é€»è¾‘ä¿æŒä¸å˜ï¼šæŸ¥çœ‹æ¯å¹´æ€»é¢
        const years = [...new Set(pRecs.map(r => new Date(r.ts).getFullYear()))].sort();
        labels = years.map(y => y + 'å¹´');
        vals = years.map(y => pRecs.filter(r => new Date(r.ts).getFullYear() === y).reduce((s,r)=>s+r.amount, 0));
    } 
    else if (range === 'monthly') {
        // --- æ ¸å¿ƒä¿®æ”¹ï¼šæ”¹ä¸ºæŸ¥çœ‹å»å¹´æœˆæ˜ç»† ---
        const lastYear = currentYear - 1; 
        labels = ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'];
        
        // åˆå§‹åŒ–å»å¹´çš„12ä¸ªæœˆ
        vals = Array(12).fill(0);
        pRecs.forEach(r => {
            const d = new Date(r.ts);
            // åªæœ‰å½“å¹´ä»½ç­‰äºå»å¹´æ—¶æ‰è®¡å…¥
            if (d.getFullYear() === lastYear) {
                vals[d.getMonth()] += r.amount;
            }
        });
        // ----------------------------------
    } 
    else {
        // é»˜è®¤é€»è¾‘ï¼šè¿‡å» 12 ä¸ªæœˆè¶‹åŠ¿
        const timeline = getTimeline();
        labels = timeline.map(t => t.label);
        vals = timeline.map(t => pRecs.filter(r => r.ts >= t.start && r.ts < t.end).reduce((s,r)=>s+r.amount, 0));
    }


    // è®¡ç®—æ‰¿è¯ºçº¿æ•°å€¼
    let promiseValue = null;
    if (supporterProfile && range !== 'yearly') {
        const rawAmt = parseFloat(supporterProfile.amount) || 0;
        if (supporterProfile.freq === 'æŒ‰æœˆ') promiseValue = rawAmt;
        if (supporterProfile.freq === 'æŒ‰å¹´') promiseValue = rawAmt / 12;
    }

    const ctx = document.getElementById('pBarChart').getContext('2d');
    if(charts.p) charts.p.destroy();
    
    const datasets = [{ 
        label: 'å®é™…æ”¯æŒ', 
        data: vals, 
        backgroundColor: '#6366f1', 
        borderRadius: 6,
        order: 2
    }];

    // å¦‚æœæœ‰æ‰¿è¯ºé‡‘é¢ä¸”ä¸æ˜¯â€œä¸å®šæœŸâ€ï¼Œåˆ™å¢åŠ ä¸€æ¡è™šçº¿
    if (promiseValue !== null) {
        datasets.push({
            label: 'æ‰¿è¯ºæœˆé¢',
            data: Array(labels.length).fill(promiseValue),
            type: 'line',
            borderColor: '#f97316',
            borderDash: [5, 5],
            borderWidth: 2,
            pointRadius: 0,
            fill: false,
            order: 1
        });
    }

    charts.p = new Chart(ctx, { 
        type: 'bar', 
        data: { labels, datasets }, 
        options: {
            ...chartBase,
            plugins: {
                legend: { display: !!promiseValue } // åªæœ‰æœ‰çº¿æ—¶æ‰æ˜¾ç¤ºå›¾ä¾‹
            }
        } 
    });
}


    function runAnalysis() {

  // --- æ–°å¢ï¼šåˆ·æ–°åä»æœ¬åœ°å­˜å‚¨å›å¡«ç›®æ ‡ ---
    const savedGoal = localStorage.getItem('sup_manual_goal');
    const targetInput = document.getElementById('monthlyTargetInput');
    if (savedGoal && (!targetInput.value || targetInput.value == "0")) {
        targetInput.value = savedGoal;
        monthlyTarget = parseFloat(savedGoal); // åŒæ­¥å…¨å±€å˜é‡
    }

        const now = new Date();
        const yearRecs = records.filter(r => r.ts >= new Date(now.getFullYear(), 0, 1).getTime());
        const firstDay = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-01`;
    const today = now.toISOString().split('T')[0];
    
    const startInput = document.getElementById('mStart');
    const endInput = document.getElementById('mEnd');
    
    if (!startInput.value) startInput.value = firstDay;
    if (!endInput.value) endInput.value = today;
        
        
        
        document.getElementById('totalYear').innerText = `Â¥ ${yearRecs.reduce((s,r)=>s+r.amount,0).toFixed(2)}`;
        const latest = [...records].sort((a,b) => b.ts - a.ts)[0];
        document.getElementById('lastDetail').innerText = latest ? `${latest.date} (${latest.name})` : "-";
        document.getElementById('pSearchList').innerHTML = [...new Set(records.map(r => r.name))].map(n => `<option value="${n}">`).join('');
        
          calculateMethodStats(); // è§¦å‘ç»Ÿè®¡


        const mData = Array(12).fill(0);
        yearRecs.forEach(r => { const m = new Date(r.ts).getMonth(); mData[m] += r.amount; });
        const ctx = document.getElementById('mainDoughnut').getContext('2d');
        if(charts.main) charts.main.destroy();
        charts.main = new Chart(ctx, { type: 'doughnut', data: { labels: ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'], datasets: [{ data: mData, backgroundColor: getColors(mData), borderWidth:0 }] }, options: { maintainAspectRatio:false, plugins:{legend:{position:'right'}} } });
        
        updateDimensionChart();
        updateGoals();

function updateMaintenancePanel() {
    const now = new Date().getTime();
    const oneMonthMs = 30 * 24 * 60 * 60 * 1000; // ä¸€ä¸ªæœˆçš„æ¯«ç§’æ•°

    const personMap = {};
    // å°†è®°å½•æŒ‰å§“ååˆ†ç»„ï¼Œå¹¶ä¿ç•™æ¯äººçš„é¢‘ç‡å±æ€§
    records.forEach(r => {
        if (!personMap[r.name]) {
            personMap[r.name] = {
                timestamps: [],
                freq: r.frequency // è·å–è¯¥æ”¯æŒè€…çš„è®¾å®šé¢‘ç‡
            };
        }
        personMap[r.name].timestamps.push(r.ts);
    });

    let dormant = [], loyal = [];

    Object.keys(personMap).forEach(name => {
        const data = personMap[name];
        const timestamps = data.timestamps.sort((a, b) => b - a); // é™åºæ’ï¼Œæœ€è¿‘çš„åœ¨æœ€å‰
        const latest = timestamps[0];
        const diffMs = now - latest;

        // --- é€»è¾‘ä¿®è®¢ï¼šåˆ†ç±»åˆ¤æ–­é€¾æœŸ ---
        let isDormant = false;
        if (data.freq === 'æŒ‰æœˆ') {
            // è¶…è¿‡ 3 ä¸ªæœˆï¼ˆçº¦ 90 å¤©ï¼‰
            if (diffMs > (3 * oneMonthMs)) isDormant = true;
        } else if (data.freq === 'æŒ‰å¹´') {
            // è¶…è¿‡ 12 ä¸ªæœˆï¼ˆçº¦ 365 å¤©ï¼‰
            if (diffMs > (12 * oneMonthMs)) isDormant = true;
        }
        // â€œä¸å®šæœŸâ€æˆ–â€œå…¶ä»–â€ç±»å‹è¿™é‡Œä¸å¤„ç†ï¼Œå³ä¸è¿›å…¥ dormant åˆ—è¡¨

        if (isDormant) {
            dormant.push(name);
        }

        // --- ä¿æŒåŸæœ‰çš„ç‰¹åˆ«è‡´è°¢é€»è¾‘ï¼ˆæœ€è¿‘6ä¸ªæœˆæ”¯æŒæ¬¡æ•° >= 5ï¼‰ ---
        const sixMonthsMs = 180 * 24 * 60 * 60 * 1000;
        const recentCount = timestamps.filter(ts => (now - ts) <= sixMonthsMs).length;
        if (recentCount >= 5) { 
            loyal.push(name);
        }
    });

    document.getElementById('dormantList').innerHTML = dormant.length ? dormant.map(n => `<span class="badge-name">${n}</span>`).join('') : "æš‚æ— ";
    document.getElementById('loyalList').innerHTML = loyal.length ? loyal.map(n => `<span class="badge-name">${n}</span>`).join('') : "æš‚æ— ";
}

updateMaintenancePanel(); // æ–°å¢ï¼šæ›´æ–°ç»´æŠ¤çœ‹æ¿
    }

    function getColors(vals) {
        if(!vals.length) return [];
        const min = Math.min(...vals), max = Math.max(...vals), range = (max - min) || 1;
        return vals.map(v => {
            const r = (v-min)/range;
            return r < 0.5 ? `rgb(${Math.floor(34+(249-34)*r*2)},${Math.floor(197+(115-197)*r*2)},${Math.floor(94+(22-94)*r*2)})` : `rgb(${Math.floor(249+(239-249)*(r-0.5)*2)},${Math.floor(115+(68-115)*(r-0.5)*2)},${Math.floor(22+(68-22)*(r-0.5)*2)})`;
        });
    }

  function exportToCSV() {
    // 1. æ•°æ®æ ¡éªŒ (ä¿æŒä¸å˜)
    if (!records || !Array.isArray(records)) return;

    // 2. å†…éƒ¨æ—¥æœŸæ ¼å¼åŒ–å·¥å…·ï¼šç¡®ä¿è¾“å‡ºä¸º yyyy-mm-dd
    const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const d = new Date(dateStr.replace(/-/g, '/')); // å…¼å®¹è§£æ
        if (isNaN(d.getTime())) return dateStr; // å¦‚æœè§£æå¤±è´¥åˆ™è¿”å›åŸæ ·
        
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    };

// 2. ç”Ÿæˆæ—¶é—´æˆ³å‡½æ•° (ä¿æŒä¸å˜)
    function generateTimestamp() {
        const now = new Date();
        const YYYY = now.getFullYear();
        const MM = String(now.getMonth() + 1).padStart(2, '0');
        const DD = String(now.getDate()).padStart(2, '0');
        const HH = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');
        const ss = String(now.getSeconds()).padStart(2, '0');
        return `${YYYY}${MM}${DD}_${HH}${mm}${ss}`;
    }

    // 3. æ•°æ®è½¬ä¹‰å‡½æ•° (ä¿æŒä¸å˜)
    const escapeCSV = (field) => {
        const str = String(field);
        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
            return `"${str.replace(/"/g, '""')}"`;
        }
        return str;
    };

    // 4. æ„å»º CSV å­—ç¬¦ä¸² â€”â€” è¿™é‡Œæ˜¯æ ¸å¿ƒä¿®æ”¹ç‚¹
    const header = "\ufeffæ—¥æœŸ,å§“å,æ€§åˆ«,æ–¹å¼,åœ°åŒº,é‡‘é¢,é¢‘ç‡,å¤‡æ³¨";
const rows = records.map(r => 
    [
        formatDate(r.date), 
        r.name, 
        r.gender || '', // æ–°å¢å¯¼å‡º
        r.method || '', // æ–°å¢å¯¼å‡º
        r.area, 
        r.amount, 
        r.frequency || '', 
        r.remark || ''
    ]
    .map(escapeCSV)
    .join(",")
);
    const csv = header + "\n" + rows.join("\n");

    // 5. åˆ›å»ºä¸‹è½½é“¾æ¥
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    
    // --- æ ¸å¿ƒä¿®æ”¹ï¼šåŠ¨æ€ç”Ÿæˆæ–‡ä»¶å ---
    const timestamp = generateTimestamp();
    a.download = `${timestamp}æ”¯æŒè®°å½•è¡¨.csv`; 

    // 6. è§¦å‘ä¸‹è½½å¹¶æ¸…ç†
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url); 
}



    renderHome();

// å½“é¡µé¢èµ„æºåŠ è½½å®Œæˆåæ‰§è¡Œ
window.addEventListener('load', () => {
    // å¦‚æœä½ å¸Œæœ›æ¯æ¬¡åˆ·æ–°éƒ½å›åˆ°åˆå§‹é€‰æ‹©ç•Œé¢ï¼Œå°†ä¸‹é¢æ”¹ä¸º const lastPage = 'index';
    // å¦‚æœå¸Œæœ›è®°ä½ä¸Šæ¬¡åœ¨å“ªä¸ªç³»ç»Ÿï¼Œåˆ™ä¿ç•™åŸé€»è¾‘
    const lastPage = localStorage.getItem('current_active_page') || 'index';
    showPage(lastPage);
});



</script>

<div class="floating-btns">
    <button onclick="window.scrollTo({top: 0, behavior: 'instant'})" title="å›åˆ°é¡¶éƒ¨">
        <svg width="24" height="24" viewBox="0 0 24 24">
            <path d="M12 6L4 18H20L12 6Z" fill="none" stroke="#8b5cf6" stroke-width="1" stroke-linejoin="round" stroke-linecap="round"/>
        </svg>
    </button>
    <button onclick="window.scrollTo({top: document.documentElement.scrollHeight, behavior: 'instant'})" title="å›åˆ°åº•éƒ¨">
        <svg width="24" height="24" viewBox="0 0 24 24">
            <path d="M12 18L20 6H4L12 18Z" fill="none" stroke="#8b5cf6" stroke-width="1" stroke-linejoin="round" stroke-linecap="round"/>
        </svg>
    </button>
</div>


</body>
</html>